<!-- static/html/viewer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Open-Ended Idea Evolution</title>

  <!-- Favicon -->
  <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/viewer.css" />

  <style>
    .controls-panel {
      width: 300px;
      padding: 20px;
      background: #f8f9fa;
      border-right: 1px solid #dee2e6;
      height: 100vh;
      position: fixed;
      overflow-y: auto;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      margin-left: 300px;
    }
    .layout-container {
      display: flex;
    }
    .nav-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    .controls-section {
      margin-bottom: 20px;
    }
    .form-label {
      margin-top: 10px;
      font-weight: 500;
    }
    .nav-buttons {
      display: flex;
      width: 100%;
      gap: 0;
    }
    .nav-buttons .btn {
      flex: 1;
      border-radius: 0;
    }
    .nav-buttons .btn:first-child {
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }
    .nav-buttons .btn:last-child {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }
    .card {
      margin-bottom: 1rem;
      border: 1px solid rgba(0,0,0,.125);
    }
    .card-body {
      padding: 0.75rem;
    }
    .context-wrapper {
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .context-wrapper p {
      margin: 0;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .context-navigation {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #dee2e6;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .evolution-content {
      background: white;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,.125);
      padding: 1rem;
      min-height: 600px;
    }

    /* Template Entry Section - Clean and Simple */
    .template-entry-section {
      margin-bottom: 2rem;
    }

    .entry-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .entry-card h3 {
      color: #495057;
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }

    .entry-input {
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1rem;
    }

    .entry-input:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }

    .example-link {
      color: #007bff;
      cursor: pointer;
      text-decoration: underline;
      margin-right: 1rem;
    }

    .example-link:hover {
      color: #0056b3;
    }
  </style>
</head>
<body>
  {% if api_key_missing %}
  <div class="alert alert-warning text-center mb-0" role="alert">
    GEMINI_API_KEY environment variable is not set. The app will not work without it.
  </div>
  <script>window.apiKeyMissing = true;</script>
  {% else %}
  <script>window.apiKeyMissing = false;</script>
  {% endif %}
  <div class="container-fluid">
    <div class="layout-container">
      <!-- Fixed side panel for controls -->
      <div class="controls-panel" id="controlsPanel">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div class="app-header">
          <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
          <h2>Controls</h2>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
          <div class="nav-buttons">
            <a href="/" class="btn btn-primary">Evolution</a>
            <a href="/rate" class="btn btn-outline-primary">Rate Ideas</a>
          </div>
          <div class="nav-buttons mt-2">
            <a href="/templates" class="btn btn-outline-secondary w-100">
              <i class="fas fa-file-alt"></i> Manage Templates
            </a>
          </div>
        </div>

        <!-- Evolution selector -->
        <div class="controls-section">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Evolution History</label>
            <button class="btn btn-sm btn-outline-primary" id="newEvolutionBtn" style="display: none;">
              <i class="fas fa-plus me-1"></i>New
            </button>
          </div>
          <select id="evolutionSelect" class="form-select mb-3">
            <option value="">Select a previous evolution...</option>
          </select>
        </div>

        <!-- Evolution Configuration -->
        <div class="controls-section">
          <h5 class="mb-3">Evolution Configuration</h5>

          <!-- Idea Type Selection -->
          <div class="mb-3">
            <label for="ideaTypeDisplay" class="form-label">Selected Template</label>
            <div class="form-control bg-light" id="ideaTypeDisplay" style="color: #6c757d; font-style: italic;">
              No template selected
            </div>
            <input type="hidden" id="ideaType" value="">
          </div>
          <div class="mb-3">
            <label for="modelType" class="form-label">Model Type</label>
            <select class="form-select" id="modelType">
              <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-2.5-flash-lite-preview-06-17" selected>Gemini 2.5 Flash Lite</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="popSize" class="form-label">Population Size</label>
            <input type="number" class="form-control" id="popSize" value="3">
          </div>
          <div class="mb-3">
            <label for="generations" class="form-label">Number of Generations</label>
            <input type="number" class="form-control" id="generations" value="2">
          </div>

          <!-- Advanced Configuration (Temperature Controls) -->
          <div class="mb-3">
            <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#temperatureControls"
                    aria-expanded="false"
                    aria-controls="temperatureControls">
              Advanced Configuration
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="temperatureControls">
              <div class="card card-body">
                <h6 class="mb-3">LLM Controls</h6>

                <!-- Creative Temperature -->
                <div class="mb-3">
                  <label for="creativeTemp" class="form-label d-flex justify-content-between">
                    <span>Creative Temperature</span>
                    <span id="creativeTempValue">1.5</span>
                  </label>
                  <input type="range" class="form-range" min="0" max="2" step="0.1" id="creativeTemp" value="1.5" oninput="document.getElementById('creativeTempValue').textContent = this.value">
                  <small class="text-muted">Controls the creativity of the LLM. Higher values are more creative.</small>
                </div>

                <!-- Top P -->
                <div class="mb-3">
                  <label for="topP" class="form-label d-flex justify-content-between">
                    <span>Top P</span>
                    <span id="topPValue">0.90</span>
                  </label>
                  <input type="range" class="form-range" min="0" max="1" step="0.01" id="topP" value="0.9" oninput="document.getElementById('topPValue').textContent = this.value">
                  <small class="text-muted">Controls the diversity of the LLM's responses.</small>
                </div>

                <!-- Thinking Budget (only for Gemini 2.5 models) -->
                <div class="mb-3" id="thinkingBudgetContainer" style="display: none;">
                  <label class="form-label">Thinking Budget</label>

                  <!-- Radio button options -->
                  <div class="mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingDynamic" value="dynamic" checked onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingDynamic">
                        <strong>Dynamic</strong> - Model decides when and how much to think
                      </label>
                    </div>
                    <div class="form-check" id="thinkingDisabledOption" style="display: none;">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingDisabled" value="disabled" onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingDisabled">
                        <strong>Disabled</strong> - Turn off thinking completely
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingCustom" value="custom" onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingCustom">
                        <strong>Custom</strong> - Set specific token budget
                      </label>
                    </div>
                  </div>

                  <!-- Custom slider (only shown when Custom is selected) -->
                  <div id="thinkingBudgetCustomContainer" style="display: none;">
                    <label for="thinkingBudgetSlider" class="form-label d-flex justify-content-between">
                      <span>Token Budget</span>
                      <span id="thinkingBudgetValue">1000</span>
                    </label>
                                         <input type="range" class="form-range" min="128" max="32768" step="128" id="thinkingBudgetSlider" value="1000" oninput="updateThinkingBudgetDisplay()">
                     <div class="d-flex justify-content-between">
                       <small class="text-muted" id="thinkingBudgetMin">128</small>
                       <small class="text-muted" id="thinkingBudgetMax">32768</small>
                     </div>
                  </div>

                  <small class="text-muted" id="thinkingBudgetHelp">Dynamic thinking: Model decides when and how much to think</small>
                </div>

                <h6 class="mb-3 mt-4">Tournament Controls</h6>

                <!-- Tournament Size -->
                <div class="mb-3">
                  <label for="tournamentSize" class="form-label d-flex justify-content-between">
                    <span>Tournament Size</span>
                    <span id="tournamentSizeValue">5</span>
                  </label>
                  <input type="range" class="form-range" min="2" max="10" step="1" id="tournamentSize" value="5" oninput="document.getElementById('tournamentSizeValue').textContent = this.value">
                  <small class="text-muted">Number of ideas in each tournament group</small>
                </div>

                <!-- Tournament Comparisons -->
                <div class="mb-3">
                  <label for="tournamentComparisons" class="form-label d-flex justify-content-between">
                    <span>Tournament Comparisons</span>
                    <span id="tournamentComparisonsValue">35</span>
                  </label>
                  <input type="range" class="form-range" min="5" max="100" step="5" id="tournamentComparisons" value="35" oninput="document.getElementById('tournamentComparisonsValue').textContent = this.value">
                  <small class="text-muted">Number of comparisons to run in each tournament</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="controls-section">
          <button class="btn btn-primary w-100 mb-2" id="startButton" {% if api_key_missing %}disabled{% endif %}>Start Evolution</button>
          <button class="btn btn-danger w-100 mb-2" id="stopButton" disabled style="display: none;">Stop Evolution</button>
          <button class="btn btn-secondary w-100" id="downloadButton" disabled>Save Results</button>
        </div>
      </div>

      <!-- Main content area -->
      <div class="main-content" id="mainContent">
        <div class="app-header main-header">
          <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
          <h1>Open-Ended Idea Evolution</h1>
        </div>

        <!-- Template Generation Entry Point -->
        <div id="templateEntry" class="template-entry-section">
          <div class="entry-card">
            <h3>
              <i class="fas fa-magic me-2"></i>
              What kind of ideas do you want to generate?
            </h3>

            <div class="entry-form">
              <textarea
                class="form-control entry-input"
                id="ideaTypeInput"
                placeholder="Describe the ideas you want to generate and evolve, specifying any important constraints and/or evaluation criteria"
                rows="3"
              ></textarea>

              <div class="entry-actions mt-3">
                <button class="btn btn-primary" id="generateTemplateBtn">
                  <i class="fas fa-magic me-2"></i>Generate Evolution Template
                </button>
                <div class="entry-examples mt-2">
                  <small class="text-muted">
                    <strong>Try:</strong>
                    <span class="example-link" onclick="setEntryText('Arduino project tutorials for beginners using only common components under $20')">Arduino projects</span>
                    <span class="example-link" onclick="setEntryText('Data visualization concepts that explain climate trends in under 60 seconds')">Climate visualizations</span>
                    <span class="example-link" onclick="setEntryText('Math problems solvable by high schoolers in under 5 minutes with elegant solutions')">Math problems</span>
                    <span class="example-link" onclick="setEntryText('Python code optimization tips demonstrable in under 10 lines of code')">Code optimizations</span>
                    <span class="example-link" onclick="setEntryText('Home science experiments using only kitchen materials and measurable results')">Kitchen science</span>
                  </small>
                </div>
              </div>

              <!-- Generation Status -->
              <div id="generationStatus" class="mt-3" style="display: none;">
                <div class="alert" id="statusAlert">
                  <span id="statusText"></span>
                </div>
              </div>

              <!-- Template Preview Section -->
              <div id="templatePreview" class="mt-4" style="display: none;">
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-check-circle me-2"></i>
                      Template Generated Successfully!
                    </h6>
                  </div>
                  <div class="card-body">
                    <div id="templatePreviewContent">
                      <!-- Template preview will be populated here -->
                    </div>
                    <div class="template-actions mt-3">
                      <button class="btn btn-primary me-2" id="saveTemplateBtn">
                        <i class="fas fa-save me-2"></i>Save & Use Template
                      </button>
                      <button class="btn btn-outline-secondary" id="reviewEditBtn">
                        <i class="fas fa-edit me-2"></i>Review & Edit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Existing Templates Section -->
          <div id="existingTemplates" class="mt-4" style="display: none;">
            <div class="entry-card">
              <h5 class="mb-3">
                <i class="fas fa-folder-open me-2"></i>
                Or choose from existing templates:
              </h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Template Name</th>
                      <th>Description</th>
                      <th>Item Type</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="templatesTableBody">
                    <!-- Templates will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Evolution content container -->
        <div class="evolution-content">
          <!-- Hidden context container that will be used by JavaScript -->
          <div id="contextContainer" style="display: none; position: absolute; visibility: hidden;">
            <div id="contextDisplay" class="context-wrapper">
              <p class="text-muted">Context will appear here when evolution starts...</p>
            </div>
            <div class="context-navigation" style="display: none;">
              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="prevContext">&larr;</button>
                <small id="contextCounter" class="text-muted">Context 1 of 3</small>
                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="nextContext">&rarr;</button>
              </div>
            </div>
          </div>

          <!-- Generations will be rendered here -->
          <div id="generations-container" class="generations-container">
            <!-- Generation content will be dynamically added here -->
          </div>

          <!-- Diversity Plot Section -->
          <div id="diversity-plot-section" class="diversity-plot-section" style="display: none;">
            <div class="diversity-plot-header">
              <h3 class="diversity-plot-title">Population Diversity Evolution</h3>
              <div class="diversity-plot-controls">
                <button class="btn btn-sm btn-outline-primary" id="diversity-axis-toggle" title="Toggle between combined and split y-axes">
                  <i class="fas fa-arrows-alt-v"></i> Split Axes
                </button>
                <button class="diversity-plot-toggle btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#diversity-plot-content" aria-expanded="true" aria-controls="diversity-plot-content">
                  <i class="fas fa-chevron-up"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="diversity-plot-content">
              <div class="diversity-plot-container">
                <canvas id="diversity-chart" width="800" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal fade" id="saveDataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save Evolution Results</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="saveFilename" class="form-label">Filename</label>
            <input type="text" class="form-control" id="saveFilename">
            <small class="text-muted">File will be saved in the data/ directory</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for idea details -->
  <div class="modal fade" id="ideaModal" tabindex="-1" aria-labelledby="ideaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ideaModalLabel">Idea Title</h5>
          <div class="d-flex align-items-start ms-auto">
            <button type="button" id="copyIdeaButton" class="btn btn-outline-secondary btn-sm me-2" title="Copy raw markdown">
              <i class="fa-regular fa-copy"></i>
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body">
          <div id="ideaModalContent" class="idea-content"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js library for cost visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sidebar Toggle Script -->
  <script>
    // Simple sidebar toggle for mobile only
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const controlsPanel = document.getElementById('controlsPanel');

      function isMobile() {
        return window.innerWidth <= 576;
      }

      sidebarToggle.addEventListener('click', function() {
        if (isMobile()) {
          controlsPanel.classList.toggle('show');
        }

        // Update icon for mobile
        const icon = sidebarToggle.querySelector('i');
        if (isMobile()) {
          if (controlsPanel.classList.contains('show')) {
            icon.className = 'fas fa-times';
          } else {
            icon.className = 'fas fa-bars';
          }
        } else {
          icon.className = 'fas fa-chevron-left';
        }
      });

      // Initialize icon
      const icon = sidebarToggle.querySelector('i');
      icon.className = isMobile() ? 'fas fa-bars' : 'fas fa-chevron-left';
    });
  </script>

  <!-- Template Generation JavaScript -->
  <script>
    // State management
    let currentGeneratedTemplate = null;
    let currentMode = 'new'; // 'new' or 'evolution'

    document.addEventListener('DOMContentLoaded', function() {
      initializeInterface();

      // Template generation event listeners
      document.getElementById('generateTemplateBtn').addEventListener('click', handleTemplateGeneration);
      document.getElementById('saveTemplateBtn').addEventListener('click', saveAndUseTemplate);
      document.getElementById('reviewEditBtn').addEventListener('click', reviewAndEditTemplate);

      // State management event listeners
      document.getElementById('newEvolutionBtn').addEventListener('click', showNewEvolutionMode);
      document.getElementById('evolutionSelect').addEventListener('change', handleEvolutionSelection);

      // Enter key support
      document.getElementById('ideaTypeInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          handleTemplateGeneration();
        }
      });
    });

    async function initializeInterface() {
      // Start in new evolution mode
      await showNewEvolutionMode();
    }

    async function showNewEvolutionMode() {
      currentMode = 'new';

      // Show template entry section
      document.getElementById('templateEntry').style.display = 'block';

      // Hide new evolution button
      document.getElementById('newEvolutionBtn').style.display = 'none';

      // Clear evolution selector
      document.getElementById('evolutionSelect').value = '';

      // Clear evolution content
      document.getElementById('generations-container').innerHTML = '';
      document.getElementById('diversity-plot-section').style.display = 'none';

      // Load and show existing templates
      await loadExistingTemplates();

      // Clear any selected template in sidebar
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = 'No template selected';
      display.style.color = '#6c757d';
      display.style.fontStyle = 'italic';
      display.classList.remove('bg-success', 'text-white');
      display.classList.add('bg-light');
      document.getElementById('ideaType').value = '';
    }

    async function showEvolutionMode(evolutionId = null) {
      currentMode = 'evolution';

      // Hide template entry section
      document.getElementById('templateEntry').style.display = 'none';

      // Show new evolution button
      document.getElementById('newEvolutionBtn').style.display = 'inline-block';

      // If viewing a specific evolution, load it
      if (evolutionId) {
        // This would load the historical evolution data
        // For now, just show that we're in evolution mode
        document.getElementById('generations-container').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Loading evolution ${evolutionId}... (Historical evolution viewing to be implemented)
          </div>
        `;
      }
    }

    function handleEvolutionSelection() {
      const evolutionId = document.getElementById('evolutionSelect').value;

      if (evolutionId) {
        showEvolutionMode(evolutionId);
      } else {
        showNewEvolutionMode();
      }
    }

    // Hook for viewer.js to call when evolution starts
    window.onEvolutionStart = function() {
      if (currentMode === 'new') {
        showEvolutionMode();
      }
    };

    async function loadExistingTemplates() {
      try {
        const response = await fetch('/api/templates/');
        const data = await response.json();

        if (data.status === 'success') {
          displayExistingTemplates(data.templates);
          document.getElementById('existingTemplates').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    function displayExistingTemplates(templates) {
      const tbody = document.getElementById('templatesTableBody');
      tbody.innerHTML = '';

      Object.entries(templates).forEach(([id, template]) => {
        if (!template.error) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <strong>${template.name || id}</strong>
            </td>
            <td>
              <span class="text-muted">${(template.description || '').substring(0, 80)}${(template.description || '').length > 80 ? '...' : ''}</span>
            </td>
            <td>
              <span class="badge bg-secondary">${template.metadata?.item_type || 'Unknown'}</span>
            </td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="selectExistingTemplate('${id}', '${template.name || id}')">
                <i class="fas fa-arrow-right me-1"></i>Use
              </button>
            </td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    function selectExistingTemplate(templateId, templateName) {
      // Set the hidden field value
      document.getElementById('ideaType').value = templateId;

      // Update the display
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = templateName;
      display.style.color = '#212529';
      display.style.fontStyle = 'normal';
      display.classList.remove('bg-light');
      display.classList.add('bg-success', 'text-white');

      // Scroll to configuration panel on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('controlsPanel').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function setEntryText(text) {
      document.getElementById('ideaTypeInput').value = text;
      document.getElementById('ideaTypeInput').focus();
    }

    async function handleTemplateGeneration() {
      const ideaType = document.getElementById('ideaTypeInput').value.trim();

      if (!ideaType) {
        showSimpleAlert('Please describe the type of ideas you want to generate.', 'warning');
        document.getElementById('ideaTypeInput').focus();
        return;
      }

      const btn = document.getElementById('generateTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        showStatus('Generating template with Gemini 2.5 Pro...', 'info');
        hideTemplatePreview();

        // Generate template
        const response = await fetch('/api/templates/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea_type_suggestion: ideaType })
        });

        const data = await response.json();

        if (data.status === 'success') {
          currentGeneratedTemplate = data.template;
          showTemplatePreview(data.template);
          hideStatus();
        } else {
          showStatus('Error: ' + (data.message || 'Failed to generate template'), 'danger');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showTemplatePreview(template) {
      const preview = document.getElementById('templatePreview');
      const content = document.getElementById('templatePreviewContent');

      // Show key details about the generated template
      content.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-8">
            <h5 class="text-success">${template.name}</h5>
            <p class="text-muted mb-2">${template.description}</p>
            <small class="text-muted">
              <strong>Item Type:</strong> ${template.metadata.item_type} |
              <strong>Criteria:</strong> ${template.comparison_criteria.slice(0, 2).join(', ')}${template.comparison_criteria.length > 2 ? '...' : ''}
            </small>
          </div>
          <div class="col-md-4">
            <div class="bg-light p-2 rounded">
              <small class="text-muted">
                <i class="fas fa-cog me-1"></i> Ready to save and use<br>
                <i class="fas fa-edit me-1"></i> Or review and customize
              </small>
            </div>
          </div>
        </div>
      `;

      preview.style.display = 'block';
    }

    function hideTemplatePreview() {
      document.getElementById('templatePreview').style.display = 'none';
    }

    async function saveAndUseTemplate() {
      if (!currentGeneratedTemplate) return;

      const btn = document.getElementById('saveTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

        const response = await fetch('/api/templates/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentGeneratedTemplate.name,
            description: currentGeneratedTemplate.description,
            author: currentGeneratedTemplate.author,
            item_type: currentGeneratedTemplate.metadata.item_type,
            special_requirements: currentGeneratedTemplate.special_requirements || '',
            context_prompt: currentGeneratedTemplate.prompts.context,
            specific_prompt: currentGeneratedTemplate.prompts.specific_prompt,
            idea_prompt: currentGeneratedTemplate.prompts.idea,
            format_prompt: currentGeneratedTemplate.prompts.format,
            critique_prompt: currentGeneratedTemplate.prompts.critique,
            refine_prompt: currentGeneratedTemplate.prompts.refine,
            breed_prompt: currentGeneratedTemplate.prompts.breed,
            genotype_encode_prompt: currentGeneratedTemplate.prompts.genotype_encode,
            comparison_criteria: currentGeneratedTemplate.comparison_criteria
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          showSimpleAlert(`Template "${currentGeneratedTemplate.name}" saved successfully!`, 'success');

          // Auto-select the new template
          setTimeout(() => {
            selectNewTemplate(data.template_id, currentGeneratedTemplate.name);
          }, 500);
        } else {
          showSimpleAlert('Error saving: ' + data.message, 'error');
        }
      } catch (error) {
        showSimpleAlert('Error saving: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function reviewAndEditTemplate() {
      if (!currentGeneratedTemplate) return;

      // Store the template temporarily and redirect to template manager
      sessionStorage.setItem('pendingTemplate', JSON.stringify(currentGeneratedTemplate));
      showSimpleAlert('Opening template editor...', 'info');

      // Open template manager in new tab with indication that there's a pending template
      window.open('/templates?pending=true', '_blank');
    }

    function selectNewTemplate(templateId, templateName) {
      // Set the hidden field value
      document.getElementById('ideaType').value = templateId;

      // Update the display
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = templateName;
      display.style.color = '#212529';
      display.style.fontStyle = 'normal';
      display.classList.remove('bg-light');
      display.classList.add('bg-success', 'text-white');

      // Clear the interface
      document.getElementById('ideaTypeInput').value = '';
      hideTemplatePreview();
      currentGeneratedTemplate = null;

      // Reload the existing templates to include the new one
      loadExistingTemplates();
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('generationStatus');
      const alertDiv = document.getElementById('statusAlert');
      const textSpan = document.getElementById('statusText');

      alertDiv.className = `alert alert-${type}`;
      textSpan.innerHTML = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('generationStatus').style.display = 'none';
    }

    function showSimpleAlert(message, type) {
      const alertClass = type === 'error' ? 'danger' : type;
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

      const alertHtml = `
        <div class="alert alert-${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
          <i class="fas fa-${icon} me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', alertHtml);
    }
  </script>

  <!-- Include original viewer.js for evolution functionality -->
  <script src="/static/js/viewer.js"></script>
</body>
</html>
