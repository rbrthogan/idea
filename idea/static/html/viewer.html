<!-- static/html/viewer.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open-Ended Idea Evolution</title>

  <!-- Favicon -->
  <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/viewer.css" />

  <!-- Firebase SDK (for cloud deployment) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
</head>

<body>
  <div class="alert alert-warning text-center mb-0" role="alert" id="apiKeyAlert" style="display: none;">
    <span>API Key not configured. The app requires a Google Gemini API Key to function.</span>
    <button class="btn btn-sm btn-outline-dark ms-3" id="setupApiKeyBtn">Setup API Key</button>
  </div>
  <div class="container-fluid">
    <div class="layout-container">
      <!-- Fixed side panel for controls -->
      <div class="controls-panel" id="controlsPanel">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div class="app-header">
          <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
          <h2>Controls</h2>
        </div>

        <!-- Sidebar Views Container -->
        <div class="sidebar-views-container">

          <!-- MAIN VIEW -->
          <div class="sidebar-view active" id="view-main">
            <!-- Navigation -->
            <div class="nav-section">
              <div class="nav-buttons">
                <a href="/" class="btn btn-primary" id="navEvolutionBtn">Evolution</a>
                <a href="/rate" class="btn">Rate Ideas</a>
              </div>
            </div>

            <!-- History Section -->
            <div class="controls-section">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted mb-0" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                  <i class="fas fa-history me-1"></i>History
                </h6>
                <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="showSidebarView('history')">
                  <i class="fas fa-list me-1"></i>View All
                </button>
              </div>
              <!-- Current/Selected evolution display -->
              <div id="selectedEvolutionCard" class="selected-evolution-card mb-3" style="display: none;">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                      <span class="badge me-2" id="selectedEvolutionStatus">Complete</span>
                      <small class="text-muted" id="selectedEvolutionDate"></small>
                    </div>
                    <div class="fw-medium text-truncate" id="selectedEvolutionName" style="max-width: 180px;"></div>
                    <small class="text-muted" id="selectedEvolutionMeta"></small>
                  </div>
                  <button class="btn btn-sm btn-link text-danger p-0" onclick="clearSelectedEvolution()"
                    title="Clear selection">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <!-- Action buttons based on status -->
                <div class="mt-2 d-flex gap-2" id="selectedEvolutionActions">
                  <!-- Will be populated dynamically -->
                </div>
              </div>
              <input type="hidden" id="evolutionSelect" value="">
              <input type="hidden" id="selectedCheckpointId" value="">

              <h6 class="text-uppercase text-muted mb-3 mt-4" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                Configuration</h6>

              <!-- Idea Type Selection -->
              <div class="mb-3">
                <label class="form-label">Selected Template</label>
                <div class="template-selector d-flex align-items-center justify-content-between" id="templateStatusCard"
                  onclick="openTemplateLibrary({ scroll: true, focusSearch: true });">
                  <span class="text-truncate fw-medium" id="ideaTypeDisplay">No template selected</span>
                  <i class="fas fa-chevron-right text-muted small ms-2"></i>
                </div>
                <input type="hidden" id="ideaType" value="">
              </div>

              <div class="mb-3">
                <label for="modelType" class="form-label mb-1">Model</label>
                <select class="form-select form-select-sm" id="modelType">
                  <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                  <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                  <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash Lite</option>
                  <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                  <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                  <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                  <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                </select>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label for="popSize" class="form-label mb-1">Pop. Size</label>
                  <input type="number" class="form-control form-control-sm" id="popSize" value="3">
                </div>
                <div class="col-6">
                  <label for="generations" class="form-label mb-1">Generations</label>
                  <input type="number" class="form-control form-control-sm" id="generations" value="2">
                </div>
              </div>

              <div class="mb-3">
                <label for="maxBudget" class="form-label mb-1">Max Budget ($)</label>
                <input type="number" class="form-control form-control-sm" id="maxBudget" step="0.01" min="0"
                  placeholder="Optional">
              </div>

              <div class="mb-1">
                <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                  onclick="showSidebarView('advanced')">
                  <span><i class="fas fa-sliders-h me-2 text-muted"></i>Advanced Config</span>
                  <i class="fas fa-chevron-right text-muted small"></i>
                </button>
              </div>
            </div>

            <!-- Action Buttons Footer -->
            <div class="mt-auto p-3 border-top bg-light" id="actionButtonsFooter">
              <!-- Evolution name input (shown before starting) -->
              <div class="mb-2" id="evolutionNameSection">
                <label class="form-label small text-muted mb-1">Evolution Name</label>
                <input type="text" class="form-control form-control-sm" id="evolutionNameInput"
                  placeholder="e.g., Sci-Fi Drabbles Round 2">
                <small class="text-muted">Leave blank for auto-generated name</small>
              </div>
              <button class="btn btn-primary w-100 mb-2" id="startButton" {% if api_key_missing %}disabled{% endif %}>
                Start Evolution
              </button>
              <button class="btn btn-danger w-100 mb-2" id="stopButton" disabled style="display: none;">
                Stop Evolution
              </button>
              <button class="btn btn-warning w-100 mb-2" id="forceStopButton" style="display: none;">
                <i class="fas fa-bolt me-1"></i>Force Stop
              </button>
            </div>

            <!-- Lower-priority utilities -->
            <div class="sidebar-utility-section">
              <div class="list-group list-group-flush border-top border-bottom utility-links">
                <a href="https://github.com/rbrthogan/idea/issues/new" target="_blank"
                  class="list-group-item list-group-item-action d-flex align-items-center py-2 px-0 border-0 bg-transparent">
                  <i class="fab fa-github me-2 text-muted" style="width: 20px; text-align: center;"></i>
                  <span>Report a Bug</span>
                  <i class="fas fa-external-link-alt ms-auto text-muted small"></i>
                </a>
                <button
                  class="list-group-item list-group-item-action d-flex align-items-center py-2 px-0 border-0 bg-transparent"
                  data-bs-toggle="modal" data-bs-target="#contactModal">
                  <i class="fas fa-envelope me-2 text-muted" style="width: 20px; text-align: center;"></i>
                  <span>Contact Us</span>
                </button>
                <button
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 px-0 border-0 bg-transparent"
                  onclick="showSidebarView('settings')">
                  <span><i class="fas fa-cog me-2 text-muted"></i>Settings</span>
                  <i class="fas fa-chevron-right text-muted small"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Advanced View -->
          <div class="sidebar-view" id="view-advanced">
            <div class="p-3 border-bottom d-flex align-items-center">
              <button class="btn btn-link text-dark p-0 me-2" onclick="showSidebarView('main')">
                <i class="fas fa-arrow-left"></i>
              </button>
              <h5 class="mb-0">Advanced Config</h5>
            </div>
            <div class="p-3">
              <!-- LLM Controls -->
              <h6 class="mb-3">LLM Controls</h6>

              <!-- Creative Temperature -->
              <div class="mb-3">
                <label for="creativeTemp" class="form-label d-flex justify-content-between">
                  <span>Creative Temperature</span>
                  <span id="creativeTempValue">1.5</span>
                </label>
                <input type="range" class="form-range" min="0" max="2" step="0.1" id="creativeTemp" value="1.5"
                  oninput="document.getElementById('creativeTempValue').textContent = this.value">
                <small class="text-muted">Controls the creativity of the LLM. Higher values are more creative.</small>
              </div>

              <!-- Top P -->
              <div class="mb-3">
                <label for="topP" class="form-label d-flex justify-content-between">
                  <span>Top P</span>
                  <span id="topPValue">0.90</span>
                </label>
                <input type="range" class="form-range" min="0" max="1" step="0.01" id="topP" value="0.9"
                  oninput="document.getElementById('topPValue').textContent = this.value">
                <small class="text-muted">Controls the diversity of the LLM's responses.</small>
              </div>

              <!-- Seed Context Pool Size -->
              <div class="mb-3">
                <label for="seedContextPoolSize" class="form-label d-flex justify-content-between">
                  <span>Seed Context Pool Size</span>
                  <span id="seedContextPoolSizeValue">2</span>
                </label>
                <input type="range" class="form-range" min="1" max="8" step="1" id="seedContextPoolSize" value="2"
                  oninput="document.getElementById('seedContextPoolSizeValue').textContent = this.value">
                <small class="text-muted">Number of context-generation calls used to build the initial seed concept bank. Each +1 typically adds ~50-60 more candidate concepts before random subsampling.</small>
              </div>

              <!-- Thinking Controls (model-aware) -->
              <div class="mb-3" id="thinkingBudgetContainer" style="display: none;">
                <label class="form-label">Thinking</label>

                <!-- Radio button options -->
                <div class="mb-2">
                  <div class="form-check" id="thinkingOffOption">
                    <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingOff"
                      value="off" checked onchange="updateThinkingBudgetMode()">
                    <label class="form-check-label" for="thinkingOff">
                      <strong>Off</strong> - Prefer speed and lower cost
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingLow"
                      value="low" onchange="updateThinkingBudgetMode()">
                    <label class="form-check-label" for="thinkingLow">
                      <strong>Low</strong> - Lightweight reasoning
                    </label>
                  </div>
                  <div class="form-check" id="thinkingMediumOption">
                    <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingMedium"
                      value="medium" onchange="updateThinkingBudgetMode()">
                    <label class="form-check-label" for="thinkingMedium">
                      <strong>Medium</strong> - Balanced depth and latency
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingHigh"
                      value="high" onchange="updateThinkingBudgetMode()">
                    <label class="form-check-label" for="thinkingHigh">
                      <strong>High</strong> - Deeper reasoning
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingCustomBudget"
                      value="custom" onchange="updateThinkingBudgetMode()">
                    <label class="form-check-label" for="thinkingCustomBudget">
                      <strong>Custom Budget</strong> - Set specific token budget
                    </label>
                  </div>
                </div>

                <!-- Custom slider (only shown when Custom is selected) -->
                <div id="thinkingBudgetCustomContainer" style="display: none;">
                  <label for="thinkingBudgetSlider" class="form-label d-flex justify-content-between">
                    <span>Token Budget</span>
                    <span id="thinkingBudgetValue">1000</span>
                  </label>
                  <input type="range" class="form-range" min="128" max="32768" step="128" id="thinkingBudgetSlider"
                    value="1000" oninput="updateThinkingBudgetDisplay()">
                  <div class="d-flex justify-content-between">
                    <small class="text-muted" id="thinkingBudgetMin">128</small>
                    <small class="text-muted" id="thinkingBudgetMax">32768</small>
                  </div>
                </div>

                <small class="text-muted" id="thinkingBudgetHelp">Select a thinking preset or set a custom token
                  budget.</small>
              </div>

              <h6 class="mb-3 mt-4">Swiss Tournament Controls</h6>

              <!-- Tournament Count -->
              <div class="mb-3">
                <label for="tournamentCount" class="form-label d-flex justify-content-between">
                  <span>Tournament Count</span>
                  <span id="tournamentCountValue">1.00</span>
                </label>
                <input type="range" class="form-range" min="0.25" max="3" step="0.25" id="tournamentCount" value="1"
                  oninput="document.getElementById('tournamentCountValue').textContent = parseFloat(this.value).toFixed(2)">
                <small class="text-muted">1.00 = full Swiss tournament (pop size âˆ’ 1 rounds). Fractions run proportional rounds.</small>
              </div>

              <h6 class="mb-3 mt-4">Breeding Controls</h6>

              <!-- Mutation Rate -->
              <div class="mb-3">
                <label for="mutationRate" class="form-label d-flex justify-content-between">
                  <span>Mutation Rate</span>
                  <span id="mutationRateValue">0.20</span>
                </label>
                <input type="range" class="form-range" min="0" max="1" step="0.05" id="mutationRate" value="0.2"
                  oninput="document.getElementById('mutationRateValue').textContent = parseFloat(this.value).toFixed(2)">
                <small class="text-muted">Probability of injecting fresh concepts during breeding (0 = no
                  mutation)</small>
              </div>

              <div class="mb-3">
                <label for="replacementRate" class="form-label d-flex justify-content-between">
                  <span>Replacement Rate</span>
                  <span id="replacementRateValue">0.50</span>
                </label>
                <input type="range" class="form-range" min="0" max="1" step="0.05" id="replacementRate" value="0.5"
                  oninput="document.getElementById('replacementRateValue').textContent = parseFloat(this.value).toFixed(2)">
                <small class="text-muted">Fraction of population replaced with new children each generation.</small>
              </div>

              <div class="mb-3">
                <label for="fitnessAlpha" class="form-label d-flex justify-content-between">
                  <span>Fitness Alpha (Elo Weight)</span>
                  <span id="fitnessAlphaValue">0.70</span>
                </label>
                <input type="range" class="form-range" min="0" max="1" step="0.05" id="fitnessAlpha" value="0.7"
                  oninput="document.getElementById('fitnessAlphaValue').textContent = parseFloat(this.value).toFixed(2)">
                <small class="text-muted">Hybrid fitness = alpha*Elo + (1-alpha)*diversity (normalized).</small>
              </div>

              <div class="mb-3">
                <label for="ageDecayRate" class="form-label d-flex justify-content-between">
                  <span>Age Decay Rate</span>
                  <span id="ageDecayRateValue">0.25</span>
                </label>
                <input type="range" class="form-range" min="0" max="1.5" step="0.05" id="ageDecayRate" value="0.25"
                  oninput="document.getElementById('ageDecayRateValue').textContent = parseFloat(this.value).toFixed(2)">
                <small class="text-muted">Higher values retire old ideas faster during survivor selection.</small>
              </div>
            </div>
          </div>

          <!-- Templates View -->
          <div class="sidebar-view" id="view-templates">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <button class="btn btn-link text-dark p-0 me-2" onclick="showSidebarView('main')">
                  <i class="fas fa-arrow-left"></i>
                </button>
                <h5 class="mb-0">Template Setup</h5>
              </div>
            </div>
            <div class="p-3">
              <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Template selection and creation now live in the main workspace to keep onboarding simple.
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="openTemplateLibrary({ scroll: true, focusSearch: true });">
                  <i class="fas fa-folder-open me-2"></i>Open Template Library
                </button>
                <button class="btn btn-outline-secondary" onclick="openTemplateGenerator({ scroll: true });">
                  <i class="fas fa-magic me-2"></i>Create with AI
                </button>
              </div>
            </div>
          </div>

          <!-- History View -->
          <div class="sidebar-view" id="view-history">
            <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <button class="btn btn-link text-dark p-0 me-2" onclick="showSidebarView('main')">
                  <i class="fas fa-arrow-left"></i>
                </button>
                <h5 class="mb-0">History</h5>
              </div>
              <button class="btn btn-sm btn-outline-secondary" onclick="refreshHistoryList()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <div class="p-3">
              <!-- History list -->
              <div id="historyList" class="history-list">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
          </div>

          <!-- SETTINGS VIEW -->
          <div class="sidebar-view" id="view-settings">
            <div class="sidebar-header p-3 border-bottom d-flex align-items-center">
              <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showSidebarView('main')">
                <i class="fas fa-arrow-left"></i>
              </button>
              <h6 class="m-0 fw-bold">Settings</h6>
            </div>

            <div class="p-3">
              <div class="mb-3">
                <label class="form-label">Gemini API Key</label>

                <!-- State A: No Key -->
                <div id="apiKeyInputContainer">
                  <input type="password" class="form-control mb-2" id="apiKeyInput" placeholder="Enter API Key">
                  <div class="form-text small mb-2">
                    <i class="fas fa-lock me-1 text-success"></i>
                    <strong>Securely encrypted</strong> at rest using AES-256 encryption.
                  </div>
                  <div class="form-text small mb-3 text-muted">
                    Your API key is used to call Gemini models for idea generation.
                  </div>
                  <button class="btn btn-primary w-100" id="saveSettingsBtn">
                    <i class="fas fa-save me-2"></i>Save Key
                  </button>
                </div>

                <!-- State B: Key Configured -->
                <div id="apiKeyConfiguredContainer" style="display: none;">
                  <div class="alert alert-success d-flex align-items-center py-2 px-3 mb-3">
                    <i class="fas fa-check-circle me-2"></i>
                    <div class="text-truncate flex-grow-1">
                      Key is set (<span id="maskedKeyDisplay">...</span>)
                    </div>
                  </div>

                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary" id="copyApiKeyBtn">
                      <i class="fas fa-copy me-2"></i>Copy Key
                    </button>
                    <button class="btn btn-outline-danger" id="deleteApiKeyBtn" type="button">
                      <i class="fas fa-trash-alt me-2"></i>Delete Key
                    </button>
                  </div>
                </div>

                <div id="settingsStatus" class="mt-3" style="display: none;"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Main content area -->
      <div class="main-content" id="mainContent">
        <div class="app-header main-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
            <h1>Open-Ended Idea Evolution</h1>
          </div>
          <!-- Auth container for sign-in button / user info -->
          <div id="authContainer" class="d-flex align-items-center">
            <!-- Will be populated by auth.js -->
          </div>
        </div>

        <!-- Template Generation Entry Point -->
        <div id="templateEntry" class="template-entry-section">
          <div class="entry-card">
            <h3>
              <i class="fas fa-compass me-2"></i>
              Choose your template
            </h3>
            <p class="text-muted mb-4">Pick one path to start. You can switch anytime.</p>

            <div class="template-flow-toggle mb-4" role="tablist" aria-label="Template setup mode">
              <button type="button" class="btn btn-outline-primary active" id="modeUseExistingBtn"
                onclick="setTemplateFlowMode('browse', { focusSearch: true })" aria-pressed="true">
                <i class="fas fa-folder-open me-2"></i>Use Existing
              </button>
              <button type="button" class="btn btn-outline-primary" id="modeGenerateBtn"
                onclick="setTemplateFlowMode('generate', { focusInput: true })" aria-pressed="false">
                <i class="fas fa-magic me-2"></i>Create with AI
              </button>
            </div>

            <div class="entry-form" id="generateTemplatePanel" style="display: none;">
              <h5 class="text-start mb-3">
                <i class="fas fa-magic me-2"></i>
                Describe what you want to generate
              </h5>
              <textarea class="form-control entry-input" id="ideaTypeInput"
                placeholder="Describe the ideas you want to generate and evolve, specifying any important constraints and/or evaluation criteria"
                rows="3"></textarea>

              <div class="entry-actions mt-3">
                <button class="btn btn-primary btn-lg w-100" id="generateTemplateBtn">
                  <i class="fas fa-pen-fancy me-2"></i>Generate Evolution Template
                </button>

                <div class="text-center mt-3">
                  <small class="text-muted">
                    <a href="#" onclick="openTemplateLibrary({ focusSearch: true }); return false;"
                      class="text-decoration-none text-secondary">
                      <i class="fas fa-folder-open me-1"></i> Switch to existing templates
                    </a>
                  </small>
                </div>
              </div>

              <div class="mt-3 text-center">
                <small class="text-muted">
                  <strong>Try:</strong>
                  <span class="example-link"
                    onclick="setEntryText('Arduino project ideas for beginners using only common components under $20 - outline only')">Arduino
                    projects</span>
                  <span class="example-link"
                    onclick="setEntryText('New and original concept for a superhero characters - short pitch')">Superhero
                    character design</span>
                  <span class="example-link"
                    onclick="setEntryText('Interesting Math problems solvable by high schoolers in under 5 minutes with elegant solutions')">Math
                    problems</span>
                  <span class="example-link"
                    onclick="setEntryText('Surprising Python code optimization tips demonstrable in under 10 lines of code')">Code
                    optimizations</span>
                  <span class="example-link"
                    onclick="setEntryText('Home science experiments using only kitchen materials and measurable results')">Kitchen
                    science</span>

                </small>
              </div>
            </div>

            <!-- Generation Status -->
            <div id="generationStatus" class="mt-3" style="display: none;">
              <div class="alert" id="statusAlert">
                <i class="fas fa-spinner fa-spin me-2" id="statusSpinner" style="display: none;"></i>
                <span id="statusText"></span>
              </div>
            </div>

            <!-- Template Preview Section -->
            <div id="templatePreview" class="mt-4" style="display: none;">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0 text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Template Generated Successfully!
                  </h6>
                </div>
                <div class="card-body">
                  <!-- Warning about auto-generated templates -->
                  <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Templates have a large effect on evolution quality. This
                    auto-generation is only meant to speed you up -
                    please review and edit the generated prompts for best results.
                  </div>

                  <div id="templatePreviewContent">
                    <!-- Template preview will be populated here -->
                  </div>
                  <div class="template-actions mt-3">
                    <button class="btn btn-primary me-2" id="saveTemplateBtn">
                      <i class="fas fa-save me-2"></i>Save & Use Template
                    </button>
                    <button class="btn btn-outline-secondary" id="reviewEditBtn">
                      <i class="fas fa-edit me-2"></i>Review & Edit
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Existing Templates Section -->
        <div id="existingTemplates" class="mt-4" style="display: none;">
          <div class="entry-card template-library-card">
            <div class="template-library-header">
              <div>
                <h5 class="mb-1">
                  <i class="fas fa-folder-open me-2"></i>
                  Template Library
                </h5>
                <p class="template-library-subtitle mb-0">
                  Click any row to select a template and view full details, then use sidebar settings and click <strong>Start Evolution</strong>.
                </p>
              </div>
              <div class="template-library-header-actions">
                <span class="template-count-pill" id="templateLibraryCount">0 templates</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="openTemplateGenerator({ focusInput: true })">
                  <i class="fas fa-magic me-1"></i>Create with AI
                </button>
                <button class="btn btn-primary btn-sm" id="createTemplateBtn">
                  <i class="fas fa-plus me-1"></i>Create Manually
                </button>
              </div>
            </div>

            <div class="template-library-controls">
              <div class="template-library-search">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" class="form-control" id="templateSearchInput"
                    placeholder="Search by template name, description, or author..."
                    onkeyup="searchTemplatesMainPage()">
                </div>
              </div>
              <div class="template-library-filter">
                <select class="form-select" id="templateFilterSelect" onchange="filterTemplatesMainPage()">
                  <option value="all">All Templates</option>
                  <option value="core">Core Templates</option>
                  <option value="custom">Custom Templates</option>
                </select>
              </div>
            </div>

            <div class="template-library-table-wrap">
              <div class="template-library-grid-head">
                <span>Template</span>
                <span>What It Does</span>
                <span class="template-actions-head">Manage</span>
              </div>
              <div id="templatesTableBody" class="template-library-list">
                <!-- Templates will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Evolution content container -->
      <div class="evolution-content">
        <!-- Hidden context container that will be used by JavaScript -->
        <div id="contextContainer" style="display: none; position: absolute; visibility: hidden;">
          <div id="contextDisplay" class="context-wrapper">
            <p class="text-muted">Context will appear here when evolution starts...</p>
          </div>
          <div class="context-navigation" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-sm btn-outline-primary py-0 px-2" id="prevContext">&larr;</button>
              <small id="contextCounter" class="text-muted">Context 1 of 3</small>
              <button class="btn btn-sm btn-outline-primary py-0 px-2" id="nextContext">&rarr;</button>
            </div>
          </div>
        </div>

        <!-- Generations will be rendered here -->
        <div id="generations-container" class="generations-container">
          <!-- Generation content will be dynamically added here -->
        </div>

        <!-- Diversity Plot Section -->
        <div id="diversity-plot-section" class="diversity-plot-section" style="display: none;">
          <div class="diversity-plot-header">
            <h3 class="diversity-plot-title">Population Diversity Evolution</h3>
            <div class="diversity-plot-controls">
              <button class="btn btn-sm btn-outline-primary" id="diversity-axis-toggle"
                title="Toggle between combined and split y-axes">
                <i class="fas fa-arrows-alt-v"></i> Split Axes
              </button>
              <button class="diversity-plot-toggle btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                data-bs-target="#diversity-plot-content" aria-expanded="true" aria-controls="diversity-plot-content">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>
          </div>
          <div class="collapse show" id="diversity-plot-content">
            <div class="diversity-plot-container">
              <canvas id="diversity-chart" width="800" height="400"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Contact Us</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Interested in collaborating on this project? Have some ideas you want to try?
            Please
            reach out!</p>
          <form id="contactForm">
            <div class="mb-3">
              <label for="contactName" class="form-label">Name</label>
              <input type="text" class="form-control" id="contactName" required>
            </div>
            <div class="mb-3">
              <label for="contactEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="contactEmail" required>
            </div>
            <div class="mb-3">
              <label for="contactMessage" class="form-label">Message</label>
              <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sendContactBtn">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Key Confirmation Modal -->
  <div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete API Key</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the API key? You will need to enter it again to use the app.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteKeyBtn">Delete Key</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal fade" id="saveDataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save Evolution Results</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="saveFilename" class="form-label">Filename</label>
            <input type="text" class="form-control" id="saveFilename">
            <small class="text-muted">File will be saved in the data/ directory</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for idea details -->
  <div class="modal fade" id="ideaModal" tabindex="-1" aria-labelledby="ideaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ideaModalLabel">Idea Title</h5>
          <div class="d-flex align-items-start ms-auto">
            <button type="button" id="copyIdeaButton" class="btn btn-outline-secondary btn-sm me-2"
              title="Copy raw markdown">
              <i class="fa-regular fa-copy"></i>
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body">
          <div id="ideaModalContent" class="idea-content"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Welcome Modal -->
  <div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Welcome!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-2">
          <p>This personal side project was created for two reasons:</p>
          <ol>
            <li>An exploration of open endedness with LLMs</li>
            <li>A low stakes test bed for coding agents</li>
          </ol>

          <div class="alert alert-warning py-2 mb-3">
            <small><i class="fas fa-bug me-2"></i>It is likely full of bugs. There's a link in the sidebar to
              report issues.</small>
          </div>

          <h5 class="fw-bold mb-2 mt-2">Research</h5>
          <p class="mb-2">The engine itself is far from optimised, I have a lot of interesting research questions I
            want to answer with it, but little time.</p>
          <p class="mb-0">If you are interested in helping, reach out via contact form in sidebar</p>

          <p class="text-end mt-3 mb-0">- Rob</p>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js library for cost visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sidebar Toggle Script -->
  <script>
    // Mobile "show" toggle + Desktop collapse with persistence
    document.addEventListener('DOMContentLoaded', function () {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const controlsPanel = document.getElementById('controlsPanel');
      const mainContent = document.getElementById('mainContent');
      const evolutionContent = document.querySelector('.evolution-content');

      function isMobile() {
        return window.innerWidth <= 576;
      }

      // Restore desktop collapse state
      const savedCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      if (!isMobile() && savedCollapsed) {
        controlsPanel.classList.add('collapsed');
        mainContent.classList.add('sidebar-collapsed');
        if (evolutionContent) {
          evolutionContent.classList.add('sidebar-collapsed');
        }
      }

      function updateIcon() {
        const icon = sidebarToggle.querySelector('i');
        if (isMobile()) {
          icon.className = controlsPanel.classList.contains('show') ? 'fas fa-times' : 'fas fa-bars';
        } else {
          icon.className = controlsPanel.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
        }
      }

      sidebarToggle.addEventListener('click', function () {
        if (isMobile()) {
          controlsPanel.classList.toggle('show');
        } else {
          controlsPanel.classList.toggle('collapsed');
          mainContent.classList.toggle('sidebar-collapsed');
          if (evolutionContent) {
            evolutionContent.classList.toggle('sidebar-collapsed');
          }
          localStorage.setItem('sidebarCollapsed', controlsPanel.classList.contains('collapsed'));
        }
        updateIcon();
      });

      // Initialize icon
      updateIcon();

      // Update icon on resize breakpoint changes
      window.addEventListener('resize', updateIcon);
    });
  </script>

  <!-- Template Generation JavaScript -->
  <script>
    // State management
    let currentGeneratedTemplate = null;
    let currentGeneratedTemplateId = null;  // Track if the generated template has been saved
    let currentMode = 'new'; // 'new' or 'evolution'
    let currentTemplateFlowMode = 'idle'; // 'idle', 'browse', or 'generate'

    function setDisplayById(id, displayValue) {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = displayValue;
      }
    }

    function setTemplateFlowMode(mode, options = {}) {
      const { focusSearch = false, focusInput = false, scroll = false } = options;
      if (mode === 'generate') {
        currentTemplateFlowMode = 'generate';
      } else if (mode === 'browse') {
        currentTemplateFlowMode = 'browse';
      } else {
        currentTemplateFlowMode = 'idle';
      }

      const browseBtn = document.getElementById('modeUseExistingBtn');
      const generateBtn = document.getElementById('modeGenerateBtn');
      const generatePanel = document.getElementById('generateTemplatePanel');
      const existingTemplates = document.getElementById('existingTemplates');
      const generationStatus = document.getElementById('generationStatus');
      const templatePreview = document.getElementById('templatePreview');

      const isBrowse = currentTemplateFlowMode === 'browse';
      const isGenerate = currentTemplateFlowMode === 'generate';
      if (browseBtn) {
        browseBtn.classList.toggle('active', isBrowse);
        browseBtn.setAttribute('aria-pressed', isBrowse ? 'true' : 'false');
      }
      if (generateBtn) {
        generateBtn.classList.toggle('active', isGenerate);
        generateBtn.setAttribute('aria-pressed', isGenerate ? 'true' : 'false');
      }
      if (generatePanel) {
        generatePanel.style.display = isGenerate ? 'block' : 'none';
      }
      if (existingTemplates) {
        existingTemplates.style.display = isBrowse ? 'block' : 'none';
      }
      if (!isGenerate) {
        if (generationStatus) generationStatus.style.display = 'none';
        if (templatePreview) templatePreview.style.display = 'none';
      } else if (currentGeneratedTemplate) {
        showTemplatePreview(currentGeneratedTemplate);
      }

      if (scroll) {
        const target = isBrowse ? existingTemplates : document.getElementById('templateEntry');
        target?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (focusSearch && isBrowse) {
        setTimeout(() => document.getElementById('templateSearchInput')?.focus(), 50);
      }
      if (focusInput && !isBrowse) {
        setTimeout(() => document.getElementById('ideaTypeInput')?.focus(), 50);
      }
    }

    function openTemplateLibrary(options = {}) {
      if (typeof showSidebarView === 'function') {
        showSidebarView('main');
      }
      setTemplateFlowMode('browse', options);
    }

    function openTemplateGenerator(options = {}) {
      if (typeof showSidebarView === 'function') {
        showSidebarView('main');
      }
      setTemplateFlowMode('generate', options);
    }

    function onTemplateSelectionChanged() {
      renderFilteredTemplates();
    }

    window.setTemplateFlowMode = setTemplateFlowMode;
    window.openTemplateLibrary = openTemplateLibrary;
    window.openTemplateGenerator = openTemplateGenerator;
    window.onTemplateSelectionChanged = onTemplateSelectionChanged;

    document.addEventListener('DOMContentLoaded', function () {
      initializeInterface();

      // Template generation event listeners
      document.getElementById('generateTemplateBtn')?.addEventListener('click', handleTemplateGeneration);
      document.getElementById('saveTemplateBtn')?.addEventListener('click', saveAndUseTemplate);
      document.getElementById('reviewEditBtn')?.addEventListener('click', reviewAndEditTemplate);

      // State management event listeners
      document.getElementById('newEvolutionBtn')?.addEventListener('click', showNewEvolutionMode);
      document.getElementById('evolutionSelect')?.addEventListener('change', handleEvolutionSelection);

      // Settings event listeners
      document.getElementById('navEvolutionBtn')?.addEventListener('click', () => {
        // If we have a selected evolution, go there, otherwise new
        const select = document.getElementById('evolutionSelect');
        if (select.value) {
          showEvolutionMode(select.value);
        } else {
          showNewEvolutionMode();
        }
      });
      document.getElementById('saveSettingsBtn')?.addEventListener('click', saveSettings);
      document.getElementById('toggleApiKeyVisibility')?.addEventListener('click', toggleApiKeyVisibility);

      const setupBtn = document.getElementById('setupApiKeyBtn');
      if (setupBtn) {
        setupBtn.addEventListener('click', () => showSidebarView('settings'));
      }

      // Enter key support
      document.getElementById('ideaTypeInput')?.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          handleTemplateGeneration();
        }
      });
    });

    async function initializeInterface() {
      // Start in new evolution mode
      await showNewEvolutionMode();
    }

    async function showNewEvolutionMode() {
      currentMode = 'new';

      // Show template entry section
      setDisplayById('templateEntry', 'block');

      // Hide settings
      setDisplayById('settingsSection', 'none');

      // Hide new evolution button
      setDisplayById('newEvolutionBtn', 'none');

      // Clear evolution selector
      const evolutionSelect = document.getElementById('evolutionSelect');
      if (evolutionSelect) {
        evolutionSelect.value = '';
      }

      // Clear evolution content
      const generationsContainer = document.getElementById('generations-container');
      if (generationsContainer) {
        generationsContainer.innerHTML = '';
      }
      setDisplayById('diversity-plot-section', 'none');

      // Load and show existing templates
      await loadExistingTemplates();

      // If nothing is selected, let the shared sidebar catalog choose last-used/default.
      if (!document.getElementById('ideaType').value && typeof window.refreshTemplateCatalog === 'function') {
        await window.refreshTemplateCatalog({ preserveSelection: true, suppressDefaultSelection: false });
      }

      // Start in neutral mode and show details only after user picks a path.
      setTemplateFlowMode('idle');
    }

    async function showEvolutionMode(evolutionId = null) {
      currentMode = 'evolution';

      // Hide template entry section
      setDisplayById('templateEntry', 'none');
      setDisplayById('existingTemplates', 'none');

      // Hide settings
      const settingsSection = document.getElementById('settingsSection');
      if (settingsSection) {
        settingsSection.style.display = 'none';
      }

      // Show new evolution button
      setDisplayById('newEvolutionBtn', 'inline-block');

      // If viewing a specific evolution, load it
      if (evolutionId) {
        // This would load the historical evolution data
        // For now, just show that we're in evolution mode
        document.getElementById('generations-container').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Loading evolution ${evolutionId}... (Historical evolution viewing to be implemented)
          </div>
        `;
      }
    }

    async function showSettingsMode() {
      currentMode = 'settings';

      // Hide other sections
      setDisplayById('templateEntry', 'none');
      setDisplayById('existingTemplates', 'none');
      const generationsContainer = document.getElementById('generations-container');
      if (generationsContainer) {
        generationsContainer.innerHTML = '';
      }
      setDisplayById('diversity-plot-section', 'none');

      // Show settings
      setDisplayById('settingsSection', 'block');

      // Check status
      checkSettingsStatus();
    }

    async function checkSettingsStatus() {
      try {
        const response = await fetch('/api/settings/status');
        const data = await response.json();

        if (data.masked_key) {
          document.getElementById('apiKeyInput').placeholder = "API Key is set (" + data.masked_key + ")";
        }
      } catch (e) {
        console.error("Error checking settings:", e);
      }
    }

    async function saveSettings() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (!key) {
        showStatusInSettings('Please enter an API key', 'warning');
        return;
      }

      const btn = document.getElementById('saveSettingsBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

      try {
        const response = await fetch('/api/settings/api-key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key })
        });

        const data = await response.json();

        if (data.status === 'success') {
          showStatusInSettings('API Key saved successfully! Reloading...', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showStatusInSettings('Error: ' + data.message, 'danger');
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      } catch (e) {
        showStatusInSettings('Error: ' + e.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showStatusInSettings(msg, type) {
      const el = document.getElementById('settingsStatus');
      el.className = `alert alert-${type}`;
      el.textContent = msg;
      el.style.display = 'block';
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      const btn = document.getElementById('toggleApiKeyVisibility');
      if (!input || !btn) return;
      const icon = btn.querySelector('i');
      if (!icon) return;

      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function handleEvolutionSelection() {
      const evolutionId = document.getElementById('evolutionSelect').value;

      if (evolutionId) {
        showEvolutionMode(evolutionId);
      } else {
        showNewEvolutionMode();
      }
    }

    // Hook for viewer.js to call when evolution starts
    window.onEvolutionStart = function () {
      if (currentMode === 'new') {
        showEvolutionMode();
      }
    };

    async function loadExistingTemplates() {
      try {
        const response = await fetch('/api/templates/');
        const data = await response.json();

        if (data.status === 'success') {
          displayExistingTemplates(data.templates);
          setTemplateFlowMode(currentTemplateFlowMode);
          if (typeof window.refreshTemplateCatalog === 'function') {
            await window.refreshTemplateCatalog({ preserveSelection: true, suppressDefaultSelection: false });
          }
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    let allMainPageTemplates = {};
    let currentMainPageFilter = 'all';
    let currentMainPageSearch = '';

    function escapeHtmlMainPage(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function displayExistingTemplates(templates) {
      allMainPageTemplates = templates;
      renderFilteredTemplates();
    }

    function renderFilteredTemplates() {
      const listContainer = document.getElementById('templatesTableBody');
      listContainer.innerHTML = '';

      const filteredTemplates = filterAndSearchMainPageTemplates();
      const totalTemplates = Object.values(allMainPageTemplates).filter(template => !template.error).length;
      const visibleTemplates = Object.keys(filteredTemplates).length;
      const countPill = document.getElementById('templateLibraryCount');
      if (countPill) {
        countPill.textContent = visibleTemplates === totalTemplates
          ? `${totalTemplates} templates`
          : `${visibleTemplates} of ${totalTemplates}`;
      }

      Object.entries(filteredTemplates).forEach(([id, template]) => {
        if (!template.error) {
          const isCore = isCoreTemplate(id, template);
          const templateName = template.name || id;
          const escapedTemplateName = escapeHtmlMainPage(templateName);
          const description = template.description || '';
          const truncatedDescription = description.substring(0, 180);
          const escapedDescription = escapeHtmlMainPage(description);
          const isSelected = document.getElementById('ideaType')?.value === id;
          const descriptionForDisplay = isSelected ? escapedDescription : `${escapeHtmlMainPage(truncatedDescription)}${description.length > 180 ? '...' : ''}`;
          const row = document.createElement('div');
          row.className = `template-library-row ${isSelected ? 'template-row-selected' : ''}`;
          row.setAttribute('role', 'button');
          row.setAttribute('tabindex', '0');
          row.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
          row.setAttribute('aria-label', `Select template ${templateName}`);
          row.innerHTML = `
            <div class="template-library-col template-library-col-name">
              <div class="template-name-cell">
                <div class="template-name-line">
                  <span class="template-name">${escapedTemplateName}</span>
                  ${isCore ? '<span class="template-type-badge template-type-core">Core</span>' : '<span class="template-type-badge template-type-custom">Custom</span>'}
                </div>
              </div>
            </div>
            <div class="template-library-col template-library-col-description">
              <p class="template-description mb-0" title="${escapedDescription}">${descriptionForDisplay}</p>
            </div>
            <div class="template-library-col template-library-col-actions">
              <div class="template-action-group" role="group" aria-label="Template actions">
                <button class="btn btn-sm template-manage-btn" onclick="event.stopPropagation(); editTemplateMainPage('${id}')">
                  <i class="fas fa-edit me-1"></i>${isCore ? 'Customize' : 'Edit'}
                </button>
              </div>
            </div>
          `;
          row.addEventListener('click', () => selectExistingTemplate(id, templateName));
          row.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              selectExistingTemplate(id, templateName);
            }
          });
          listContainer.appendChild(row);
        }
      });

      // Show empty state if no templates match filter
      if (Object.keys(filteredTemplates).length === 0) {
        const row = document.createElement('div');
        row.className = 'text-center text-muted py-5 template-empty-state';
        row.innerHTML = `
            <i class="fas fa-search fa-2x mb-2"></i><br>
            No templates match your current search or filter.
        `;
        listContainer.appendChild(row);
      }
    }

    function filterAndSearchMainPageTemplates() {
      let filtered = {};

      for (const [templateId, templateInfo] of Object.entries(allMainPageTemplates)) {
        if (templateInfo.error) continue;

        const isCore = isCoreTemplate(templateId, templateInfo);

        // Apply filter
        if (currentMainPageFilter === 'core' && !isCore) continue;
        if (currentMainPageFilter === 'custom' && isCore) continue;

        // Apply search
        if (currentMainPageSearch) {
          const searchTerm = currentMainPageSearch.toLowerCase();
          const name = (templateInfo.name || templateId).toLowerCase();
          const description = (templateInfo.description || '').toLowerCase();
          const author = (templateInfo.author || '').toLowerCase();

          if (!name.includes(searchTerm) &&
            !description.includes(searchTerm) &&
            !author.includes(searchTerm)) {
            continue;
          }
        }

        filtered[templateId] = templateInfo;
      }

      return filtered;
    }

    function isCoreTemplate(templateId, templateInfo) {
      if (templateInfo && typeof templateInfo.is_system === 'boolean') {
        return templateInfo.is_system;
      }
      // Core templates are the original ones: airesearch, drabble, game_design
      const coreTemplates = ['airesearch', 'drabble', 'game_design'];
      return coreTemplates.includes(templateId) || templateInfo.author === 'Original Idea App';
    }

    function searchTemplatesMainPage() {
      const searchInput = document.getElementById('templateSearchInput');
      currentMainPageSearch = searchInput ? searchInput.value : '';
      renderFilteredTemplates();
    }

    function filterTemplatesMainPage() {
      const filterSelect = document.getElementById('templateFilterSelect');
      currentMainPageFilter = filterSelect ? filterSelect.value : 'all';
      renderFilteredTemplates();
    }

    function selectExistingTemplate(templateId, templateName) {
      if (typeof selectTemplate === 'function' && selectTemplate(templateId, false)) {
        // selected via shared sidebar logic
      } else {
        document.getElementById('ideaType').value = templateId;
        const display = document.getElementById('ideaTypeDisplay');
        display.textContent = templateName;
      }

      // Scroll to configuration panel on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('controlsPanel').scrollIntoView({ behavior: 'smooth' });
      }
      onTemplateSelectionChanged();
    }

    function setEntryText(text) {
      setTemplateFlowMode('generate');
      document.getElementById('ideaTypeInput').value = text;
      document.getElementById('ideaTypeInput').focus();
    }

    async function handleTemplateGeneration() {
      const ideaType = document.getElementById('ideaTypeInput').value.trim();

      if (!ideaType) {
        showSimpleAlert('Please describe the type of ideas you want to generate.', 'warning');
        document.getElementById('ideaTypeInput').focus();
        return;
      }

      const btn = document.getElementById('generateTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        showStatus('Generating template with Gemini 3.0 Pro...', 'info');
        hideTemplatePreview();

        // Generate template
        const response = await fetch('/api/templates/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea_type_suggestion: ideaType })
        });

        const data = await response.json();

        if (data.status === 'success') {
          currentGeneratedTemplate = data.template;
          currentGeneratedTemplateId = null;  // Reset saved template tracking for new generation
          showTemplatePreview(data.template);
          hideStatus();
        } else {
          showStatus('Error: ' + (data.message || 'Failed to generate template'), 'danger');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showTemplatePreview(template) {
      const preview = document.getElementById('templatePreview');
      const content = document.getElementById('templatePreviewContent');

      // Show key details about the generated template
      content.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-8">
            <h5 class="text-success">${template.name}</h5>
            <p class="text-muted mb-2">${template.description}</p>
            <small class="text-muted">
              <strong>Item Type:</strong> ${template.metadata.item_type} |
              <strong>Criteria:</strong> ${template.comparison_criteria.slice(0, 2).join(', ')}${template.comparison_criteria.length > 2 ? '...' : ''}
            </small>
          </div>
          <div class="col-md-4">
            <div class="bg-light p-2 rounded">
              <small class="text-muted">
                <i class="fas fa-cog me-1"></i> Ready to save and use<br>
                <i class="fas fa-edit me-1"></i> Or review and customize
              </small>
            </div>
          </div>
        </div>
      `;

      preview.style.display = 'block';
    }

    function hideTemplatePreview() {
      document.getElementById('templatePreview').style.display = 'none';
    }

    async function saveAndUseTemplate() {
      if (!currentGeneratedTemplate) return;

      // If template was already saved, just select it
      if (currentGeneratedTemplateId) {
        setTemplateFlowMode('browse');
        selectNewTemplate(currentGeneratedTemplateId, currentGeneratedTemplate.name);
        return;
      }

      const btn = document.getElementById('saveTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

        const response = await fetch('/api/templates/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentGeneratedTemplate.name,
            description: currentGeneratedTemplate.description,
            author: currentGeneratedTemplate.author,
            item_type: currentGeneratedTemplate.metadata.item_type,
            special_requirements: currentGeneratedTemplate.special_requirements || '',
            context_prompt: currentGeneratedTemplate.prompts.context,
            specific_prompt: currentGeneratedTemplate.prompts.specific_prompt,
            idea_prompt: currentGeneratedTemplate.prompts.idea,
            format_prompt: currentGeneratedTemplate.prompts.format,
            critique_prompt: currentGeneratedTemplate.prompts.critique,
            refine_prompt: currentGeneratedTemplate.prompts.refine,
            breed_prompt: currentGeneratedTemplate.prompts.breed,
            genotype_encode_prompt: currentGeneratedTemplate.prompts.genotype_encode,
            comparison_criteria: currentGeneratedTemplate.comparison_criteria
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          // Track that this template has been saved
          currentGeneratedTemplateId = data.template_id;

          showSimpleAlert(`Template "${currentGeneratedTemplate.name}" saved successfully!`, 'success');

          // Auto-select the new template
          setTimeout(() => {
            setTemplateFlowMode('browse');
            selectNewTemplate(data.template_id, currentGeneratedTemplate.name);
          }, 500);
        } else {
          showSimpleAlert('Error saving: ' + data.message, 'error');
        }
      } catch (error) {
        showSimpleAlert('Error saving: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function reviewAndEditTemplate() {
      if (!currentGeneratedTemplate) return;

      // If template was already saved, set up as editing existing template
      if (currentGeneratedTemplateId) {
        currentEditingTemplateId = currentGeneratedTemplateId;
        currentEditingTemplateIsSystem = false;
        document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Template';
        document.getElementById('deleteTemplateMainPageBtn').style.display = 'inline-block';
      } else {
        // Set up as new template
        currentEditingTemplateId = null;
        currentEditingTemplateIsSystem = false;
        document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-magic me-2"></i>Review Generated Template';
        document.getElementById('deleteTemplateMainPageBtn').style.display = 'none';
      }

      // Populate the form with the generated template data
      populateTemplateEditForm(currentGeneratedTemplate);

      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
      modal.show();
    }

    function selectNewTemplate(templateId, templateName) {
      if (typeof selectTemplate === 'function' && selectTemplate(templateId, false)) {
        // selected via shared sidebar logic
      } else {
        document.getElementById('ideaType').value = templateId;
        const display = document.getElementById('ideaTypeDisplay');
        display.textContent = templateName;
        onTemplateSelectionChanged();
      }

      // Clear the interface
      document.getElementById('ideaTypeInput').value = '';
      hideTemplatePreview();
      currentGeneratedTemplate = null;
      currentGeneratedTemplateId = null;

      // Reload the existing templates to include the new one
      loadExistingTemplates();
      setTemplateFlowMode('browse');
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('generationStatus');
      const alertDiv = document.getElementById('statusAlert');
      const textSpan = document.getElementById('statusText');

      alertDiv.className = `alert alert-${type}`;
      textSpan.innerHTML = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('generationStatus').style.display = 'none';
    }

    function showSimpleAlert(message, type) {
      const alertClass = type === 'error' ? 'danger' : type;
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

      // Generate a unique ID for this alert
      const alertId = 'alert-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

      const alertHtml = `
        <div id="${alertId}" class="alert alert-${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
          <i class="fas fa-${icon} me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', alertHtml);

      // Auto-dismiss after 4 seconds
      const timeoutId = setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
          // Use Bootstrap's fade out animation
          alertElement.classList.remove('show');
          // Remove from DOM after animation completes
          setTimeout(() => {
            if (alertElement.parentNode) {
              alertElement.parentNode.removeChild(alertElement);
            }
          }, 150); // Bootstrap fade transition is 150ms
        }
      }, 4000);

      // Clear timeout if user manually closes the alert
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.addEventListener('closed.bs.alert', () => {
          clearTimeout(timeoutId);
        });
      }
    }
    // Template editing functions for main page
    let currentEditingTemplateId = null;
    let currentEditingTemplateIsSystem = false;

    async function editTemplateMainPage(templateId) {
      currentEditingTemplateId = templateId;
      currentEditingTemplateIsSystem = false;

      try {
        const response = await fetch(`/api/templates/${templateId}`);
        const data = await response.json();

        if (data.status === 'success') {
          const template = data.template || {};
          const isSystem = !!template.is_system;

          if (isSystem) {
            // System templates are read-only in backend. Open as "customize copy".
            currentEditingTemplateId = null;
            currentEditingTemplateIsSystem = true;
            const copyTemplate = {
              ...template,
              name: `${template.name || templateId} Copy`
            };
            populateTemplateEditForm(copyTemplate);
            document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-copy me-2"></i>Customize System Template';
            document.getElementById('deleteTemplateMainPageBtn').style.display = 'none';
            showSimpleAlert('System templates are read-only. Saving will create a custom copy.', 'info');
          } else {
            currentEditingTemplateId = templateId;
            currentEditingTemplateIsSystem = false;
            populateTemplateEditForm(template);
            document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Template';
            document.getElementById('deleteTemplateMainPageBtn').style.display = 'inline-block';
          }

          const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
          modal.show();
        } else {
          alert('Error loading template: ' + data.message);
        }
      } catch (error) {
        alert('Error loading template: ' + error.message);
      }
    }

    async function createTemplateMainPage() {
      currentEditingTemplateId = null;
      currentEditingTemplateIsSystem = false;
      clearTemplateEditForm();
      document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Create New Template';
      const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
      modal.show();
    }

    function populateTemplateEditForm(template) {
      document.getElementById('editTemplateName').value = template.name || '';
      document.getElementById('editTemplateDescription').value = template.description || '';
      document.getElementById('editTemplateAuthor').value = template.author || 'User';
      document.getElementById('editTemplateItemType').value = template.metadata?.item_type || '';
      document.getElementById('editSpecialRequirements').value = template.special_requirements || '';

      // Populate all prompt fields
      document.getElementById('editContextPrompt').value = template.prompts?.context || '';
      document.getElementById('editSpecificPrompt').value = template.prompts?.specific_prompt || '';
      document.getElementById('editIdeaPrompt').value = template.prompts?.idea || '';
      document.getElementById('editFormatPrompt').value = template.prompts?.format || '';
      document.getElementById('editCritiquePrompt').value = template.prompts?.critique || '';
      document.getElementById('editRefinePrompt').value = template.prompts?.refine || '';
      document.getElementById('editBreedPrompt').value = template.prompts?.breed || '';
      document.getElementById('editGenotypePrompt').value = template.prompts?.genotype_encode || '';

      // Populate comparison criteria
      const criteriaContainer = document.getElementById('editCriteriaContainer');
      criteriaContainer.innerHTML = '';
      if (template.comparison_criteria && template.comparison_criteria.length > 0) {
        template.comparison_criteria.forEach(criterion => {
          addEditCriterion(criterion);
        });
      } else {
        addEditCriterion('');
      }
    }

    function clearTemplateEditForm() {
      currentEditingTemplateIsSystem = false;
      document.getElementById('editTemplateName').value = '';
      document.getElementById('editTemplateDescription').value = '';
      document.getElementById('editTemplateAuthor').value = 'User';
      document.getElementById('editTemplateItemType').value = '';
      document.getElementById('editSpecialRequirements').value = '';

      // Clear all prompt fields
      document.getElementById('editContextPrompt').value = '';
      document.getElementById('editSpecificPrompt').value = '';
      document.getElementById('editIdeaPrompt').value = '';
      document.getElementById('editFormatPrompt').value = '';
      document.getElementById('editCritiquePrompt').value = '';
      document.getElementById('editRefinePrompt').value = '';
      document.getElementById('editBreedPrompt').value = '';
      document.getElementById('editGenotypePrompt').value = '';

      // Hide delete button for new templates
      document.getElementById('deleteTemplateMainPageBtn').style.display = 'none';

      const criteriaContainer = document.getElementById('editCriteriaContainer');
      criteriaContainer.innerHTML = '';
      addEditCriterion('');
    }

    function addEditCriterion(value = '') {
      const container = document.getElementById('editCriteriaContainer');
      const criterionDiv = document.createElement('div');
      criterionDiv.className = 'input-group mb-2';
      criterionDiv.innerHTML = `
        <input type="text" class="form-control criterion-input" placeholder="e.g., originality, feasibility, clarity" value="${value}">
        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(criterionDiv);
    }

    async function saveTemplateMainPage() {
      const name = document.getElementById('editTemplateName').value.trim();
      const description = document.getElementById('editTemplateDescription').value.trim();
      const author = document.getElementById('editTemplateAuthor').value.trim();
      const itemType = document.getElementById('editTemplateItemType').value.trim();
      const specialRequirements = document.getElementById('editSpecialRequirements').value.trim();

      // Get all prompt fields
      const contextPrompt = document.getElementById('editContextPrompt').value.trim();
      const specificPrompt = document.getElementById('editSpecificPrompt').value.trim();
      const ideaPrompt = document.getElementById('editIdeaPrompt').value.trim();
      const formatPrompt = document.getElementById('editFormatPrompt').value.trim();
      const critiquePrompt = document.getElementById('editCritiquePrompt').value.trim();
      const refinePrompt = document.getElementById('editRefinePrompt').value.trim();
      const breedPrompt = document.getElementById('editBreedPrompt').value.trim();
      const genotypePrompt = document.getElementById('editGenotypePrompt').value.trim();

      if (!name || !description || !itemType) {
        alert('Please fill in all required fields (Name, Description, Item Type).');
        return;
      }

      if (!contextPrompt || !specificPrompt || !ideaPrompt || !formatPrompt ||
        !critiquePrompt || !refinePrompt || !breedPrompt || !genotypePrompt) {
        alert('Please fill in all prompt fields. All prompts are required for a complete template.');
        return;
      }

      // Validate required placeholders
      const placeholderValidation = [
        { field: 'Specific Prompt', value: specificPrompt, required: ['{context_pool}'] },
        { field: 'Idea Prompt', value: ideaPrompt, required: ['{requirements}'] },
        { field: 'Format Prompt', value: formatPrompt, required: ['{input_text}'] },
        { field: 'Critique Prompt', value: critiquePrompt, required: ['{idea}'] },
        { field: 'Refine Prompt', value: refinePrompt, required: ['{idea}', '{critique}'] },
        { field: 'Breed Prompt', value: breedPrompt, required: ['{ideas}'] },
        { field: 'Genotype Encode Prompt', value: genotypePrompt, required: ['{idea_content}'] }
      ];

      for (const validation of placeholderValidation) {
        for (const placeholder of validation.required) {
          if (!validation.value.includes(placeholder)) {
            alert(`Error: ${validation.field} must include the placeholder ${placeholder}`);
            return;
          }
        }
      }

      // Get comparison criteria
      const criteriaInputs = document.querySelectorAll('.criterion-input');
      const criteria = Array.from(criteriaInputs)
        .map(input => input.value.trim())
        .filter(value => value.length > 0);

      if (criteria.length === 0) {
        alert('Please add at least one comparison criterion.');
        return;
      }

      const templateData = {
        name,
        description,
        author,
        item_type: itemType,
        special_requirements: specialRequirements || undefined,
        context_prompt: contextPrompt,
        specific_prompt: specificPrompt,
        idea_prompt: ideaPrompt,
        format_prompt: formatPrompt,
        critique_prompt: critiquePrompt,
        refine_prompt: refinePrompt,
        breed_prompt: breedPrompt,
        genotype_encode_prompt: genotypePrompt,
        comparison_criteria: criteria
      };

      try {
        const wasUpdate = !!currentEditingTemplateId;
        const url = currentEditingTemplateId
          ? `/api/templates/${currentEditingTemplateId}`
          : '/api/templates/';
        const method = currentEditingTemplateId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(templateData)
        });

        const data = await response.json();

        if (data.status === 'success') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('templateEditModal'));
          modal.hide();
          const savedTemplateId = data.template_id || currentEditingTemplateId;

          // If this was a generated template being saved for the first time, track its ID
          if (!currentEditingTemplateId && currentGeneratedTemplate) {
            currentGeneratedTemplateId = data.template_id;
          }

          // Reload templates to show changes
          await loadExistingTemplates();
          if (savedTemplateId && typeof selectTemplate === 'function') {
            selectTemplate(savedTemplateId, false);
          }
          currentEditingTemplateId = savedTemplateId || null;
          currentEditingTemplateIsSystem = false;

          const action = wasUpdate ? 'updated' : 'created';
          showSimpleAlert(`Template ${action} successfully!`, 'success');
        } else {
          alert('Error saving template: ' + data.message);
        }
      } catch (error) {
        alert('Error saving template: ' + error.message);
      }
    }

    async function deleteTemplateMainPage() {
      if (!currentEditingTemplateId) return;
      if (currentEditingTemplateIsSystem) {
        showSimpleAlert('System templates cannot be deleted.', 'warning');
        return;
      }

      if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        return;
      }

      try {
        const deletingTemplateId = currentEditingTemplateId;
        const response = await fetch(`/api/templates/${currentEditingTemplateId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'success') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('templateEditModal'));
          modal.hide();

          // Reload templates to show changes
          await loadExistingTemplates();
          if (document.getElementById('ideaType').value === deletingTemplateId && typeof window.refreshTemplateCatalog === 'function') {
            document.getElementById('ideaType').value = '';
            await window.refreshTemplateCatalog({ preserveSelection: true, suppressDefaultSelection: false });
          }
          currentEditingTemplateId = null;
          currentEditingTemplateIsSystem = false;
          showSimpleAlert('Template deleted successfully!', 'success');
        } else {
          alert('Error deleting template: ' + data.message);
        }
      } catch (error) {
        alert('Error deleting template: ' + error.message);
      }
    }

    // Bind create template button
    document.addEventListener('DOMContentLoaded', function () {
      const createBtn = document.getElementById('createTemplateBtn');
      if (createBtn) {
        createBtn.addEventListener('click', createTemplateMainPage);
      }
    });

  </script>

  <!-- Template Edit Modal -->
  <div class="modal fade" id="templateEditModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="templateEditModalTitle">
            <i class="fas fa-edit me-2"></i>Edit Template
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <form id="templateEditForm">
            <!-- Basic Information Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-1"></i>Basic Information
                </h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="editTemplateName" class="form-label">
                      <i class="fas fa-tag me-1"></i>Template Name *
                    </label>
                    <input type="text" class="form-control" id="editTemplateName" required
                      placeholder="Enter a descriptive name">
                  </div>
                  <div class="col-md-6">
                    <label for="editTemplateAuthor" class="form-label">
                      <i class="fas fa-user me-1"></i>Author
                    </label>
                    <input type="text" class="form-control" id="editTemplateAuthor" value="User"
                      placeholder="Your name">
                  </div>
                </div>

                <div class="mb-3">
                  <label for="editTemplateDescription" class="form-label">
                    <i class="fas fa-align-left me-1"></i>Description *
                  </label>
                  <textarea class="form-control" id="editTemplateDescription" rows="2" required
                    placeholder="Describe what this template is used for"></textarea>
                </div>

                <div class="mb-3">
                  <label for="editTemplateItemType" class="form-label">
                    <i class="fas fa-lightbulb me-1"></i>Item Type *
                  </label>
                  <input type="text" class="form-control" id="editTemplateItemType" required
                    placeholder="e.g., 'research ideas', 'business plans', 'stories'">
                </div>

                <!-- Special Requirements -->
                <div class="mb-3">
                  <label for="editSpecialRequirements" class="form-label">
                    <i class="fas fa-exclamation-circle me-1"></i>Special Requirements (Optional)
                  </label>
                  <textarea class="form-control" id="editSpecialRequirements" rows="3"
                    placeholder="Special constraints like word limits, formatting requirements, etc."></textarea>
                </div>

                <!-- Comparison Criteria -->
                <div class="mb-0">
                  <label class="form-label">
                    <i class="fas fa-balance-scale me-1"></i>Comparison Criteria *
                  </label>
                  <div id="editCriteriaContainer">
                    <!-- Criteria inputs will be added here -->
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditCriterion()">
                    <i class="fas fa-plus me-1"></i>Add Criterion
                  </button>
                  <div class="form-text">
                    These criteria will be used to evaluate and compare generated ideas.
                  </div>
                </div>
              </div>
            </div>

            <!-- Prompts Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-code me-1"></i>Template Prompts
                </h6>
              </div>
              <div class="card-body">

                <!-- Context Prompt -->
                <div class="mb-3">
                  <label for="editContextPrompt" class="form-label">
                    <strong>Context Prompt</strong> *
                    <small class="text-muted">(Generates diverse concepts for idea generation)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editContextPrompt" rows="6" required
                    placeholder="Generate a diverse list of 50 specific concepts for your domain..."></textarea>
                </div>

                <!-- Specific Prompt -->
                <div class="mb-3">
                  <label for="editSpecificPrompt" class="form-label">
                    <strong>Specific Prompt</strong> *
                    <small class="text-muted">(Creates focused prompts from context pool)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editSpecificPrompt" rows="4" required placeholder="From the following concepts, select 2-3 that would create an interesting combination...
Must include: {context_pool}"></textarea>
                  <div class="form-text">
                    <strong>Required placeholder:</strong> <code>{context_pool}</code>
                  </div>
                </div>

                <!-- Idea Prompt -->
                <div class="mb-3">
                  <label for="editIdeaPrompt" class="form-label">
                    <strong>Idea Generation Prompt</strong> *
                    <small class="text-muted">(Main prompt for generating ideas)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editIdeaPrompt" rows="6" required placeholder="Your idea must incorporate concepts from the context above...
Must include: {requirements}"></textarea>
                  <div class="form-text">
                    <strong>Required placeholder:</strong> <code>{requirements}</code>
                  </div>
                </div>

                <!-- Format Prompt -->
                <div class="mb-3">
                  <label for="editFormatPrompt" class="form-label">
                    <strong>Format Prompt</strong> *
                    <small class="text-muted">(Formats and structures the generated ideas)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editFormatPrompt" rows="4" required placeholder="Take the following idea and rewrite it in a clear, structured format...
Must include: {input_text}"></textarea>
                  <div class="form-text">
                    <strong>Required placeholder:</strong> <code>{input_text}</code>
                  </div>
                </div>

                <!-- Critique Prompt -->
                <div class="mb-3">
                  <label for="editCritiquePrompt" class="form-label">
                    <strong>Critique Prompt</strong> *
                    <small class="text-muted">(Provides critical feedback on ideas)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editCritiquePrompt" rows="4" required placeholder="You are a helpful AI that critiques ideas. Current Idea: {idea}
Please offer critical feedback..."></textarea>
                  <div class="form-text">
                    <strong>Required placeholder:</strong> <code>{idea}</code>
                  </div>
                </div>

                <!-- Refine Prompt -->
                <div class="mb-3">
                  <label for="editRefinePrompt" class="form-label">
                    <strong>Refine Prompt</strong> *
                    <small class="text-muted">(Improves ideas based on critique)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editRefinePrompt" rows="4" required placeholder="Current Idea: {idea}
Critique: {critique}
Please review both and create a refined proposal..."></textarea>
                  <div class="form-text">
                    <strong>Required placeholders:</strong> <code>{idea}</code>, <code>{critique}</code>,
                    <code>{requirements}</code>
                  </div>
                </div>

                <!-- Breed Prompt -->
                <div class="mb-3">
                  <label for="editBreedPrompt" class="form-label">
                    <strong>Breed Prompt</strong> *
                    <small class="text-muted">(Creates new ideas by combining existing ones)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editBreedPrompt" rows="4" required
                    placeholder="{ideas}
Analyze the above ideas to identify patterns and create a new idea that explores underrepresented approaches..."></textarea>
                  <div class="form-text">
                    <strong>Required placeholders:</strong> <code>{ideas}</code>, <code>{requirements}</code>
                  </div>
                </div>

                <!-- Genotype Encode Prompt -->
                <div class="mb-3">
                  <label for="editGenotypePrompt" class="form-label">
                    <strong>Genotype Encode Prompt</strong> *
                    <small class="text-muted">(Extracts fundamental elements from ideas)</small>
                  </label>
                  <textarea class="form-control font-monospace" id="editGenotypePrompt" rows="5" required placeholder="You are an expert at analyzing ideas and extracting their fundamental building blocks...
Input: {idea_content}
Output: condensed list of basic elements, separated by semicolons"></textarea>
                  <div class="form-text">
                    <strong>Required placeholder:</strong> <code>{idea_content}</code>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-danger me-auto" id="deleteTemplateMainPageBtn"
            onclick="deleteTemplateMainPage()" style="display: none;">
            <i class="fas fa-trash me-1"></i>Delete
          </button>
          <button type="button" class="btn btn-primary" onclick="saveTemplateMainPage()">
            <i class="fas fa-save me-1"></i>Save Template
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include original viewer.js for evolution functionality -->
  <script src="/static/js/auth.js"></script>
  <script src="/static/js/auth_logic.js?v=3"></script>
  <script src="/static/js/viewer.js?v=3"></script>
</body>

</html>
