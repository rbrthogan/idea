<!-- static/html/viewer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open-Ended Idea Evolution</title>

  <!-- Favicon -->
  <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/viewer.css" />
</head>
<body>
  {% if api_key_missing %}
  <div class="alert alert-warning text-center mb-0" role="alert">
    GEMINI_API_KEY environment variable is not set. The app will not work without it.
  </div>
  <script>window.apiKeyMissing = true;</script>
  {% else %}
  <script>window.apiKeyMissing = false;</script>
  {% endif %}
  <div class="container-fluid">
    <div class="layout-container">
      <!-- Fixed side panel for controls -->
      <div class="controls-panel" id="controlsPanel">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div class="app-header">
          <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
          <h2>Controls</h2>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
          <div class="nav-buttons">
            <a href="/" class="btn btn-primary">Evolution</a>
            <a href="/rate" class="btn btn-outline-primary">Rate Ideas</a>
          </div>
        </div>

        <!-- Evolution selector -->
        <div class="controls-section">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Evolution History</label>
            <button class="btn btn-sm btn-outline-primary" id="newEvolutionBtn" style="display: none;">
              <i class="fas fa-plus me-1"></i>New
            </button>
          </div>
          <select id="evolutionSelect" class="form-select mb-3">
            <option value="">Select a previous evolution...</option>
          </select>
        </div>

        <!-- Evolution Configuration -->
        <div class="controls-section">
          <h5 class="mb-3">Evolution Configuration</h5>

          <!-- Idea Type Selection -->
          <div class="mb-3">
            <label for="ideaTypeDisplay" class="form-label">Selected Template</label>
            <div class="form-control bg-light" id="ideaTypeDisplay" style="color: #6c757d; font-style: italic;">
              No template selected
            </div>
            <input type="hidden" id="ideaType" value="">
          </div>
          <div class="mb-3">
            <label for="modelType" class="form-label">Model Type</label>
            <select class="form-select" id="modelType">
              <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash Lite</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
              <option value="gemini-3-pro-preview">Gemini 3 Pro Preview (SOTA)</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="popSize" class="form-label">Population Size</label>
            <input type="number" class="form-control" id="popSize" value="3">
          </div>
          <div class="mb-3">
            <label for="generations" class="form-label">Number of Generations</label>
            <input type="number" class="form-control" id="generations" value="2">
          </div>
          <div class="mb-3">
            <label for="maxBudget" class="form-label">Maximum Budget ($)</label>
            <input type="number" class="form-control" id="maxBudget" step="0.01" min="0" placeholder="Optional (e.g. 1.00)">
            <div class="form-text text-muted" style="font-size: 0.8em;">Evolution stops if cost exceeds this amount.</div>
          </div>

          <!-- Advanced Configuration (Temperature Controls) -->
          <div class="mb-3">
            <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#temperatureControls"
                    aria-expanded="false"
                    aria-controls="temperatureControls">
              Advanced Configuration
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="temperatureControls">
              <div class="card card-body">
                <h6 class="mb-3">LLM Controls</h6>

                <!-- Creative Temperature -->
                <div class="mb-3">
                  <label for="creativeTemp" class="form-label d-flex justify-content-between">
                    <span>Creative Temperature</span>
                    <span id="creativeTempValue">1.5</span>
                  </label>
                  <input type="range" class="form-range" min="0" max="2" step="0.1" id="creativeTemp" value="1.5" oninput="document.getElementById('creativeTempValue').textContent = this.value">
                  <small class="text-muted">Controls the creativity of the LLM. Higher values are more creative.</small>
                </div>

                <!-- Top P -->
                <div class="mb-3">
                  <label for="topP" class="form-label d-flex justify-content-between">
                    <span>Top P</span>
                    <span id="topPValue">0.90</span>
                  </label>
                  <input type="range" class="form-range" min="0" max="1" step="0.01" id="topP" value="0.9" oninput="document.getElementById('topPValue').textContent = this.value">
                  <small class="text-muted">Controls the diversity of the LLM's responses.</small>
                </div>

                <!-- Thinking Budget (only for Gemini 2.5 models) -->
                <div class="mb-3" id="thinkingBudgetContainer" style="display: none;">
                  <label class="form-label">Thinking Budget</label>

                  <!-- Radio button options -->
                  <div class="mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingDynamic" value="dynamic" checked onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingDynamic">
                        <strong>Dynamic</strong> - Model decides when and how much to think
                      </label>
                    </div>
                    <div class="form-check" id="thinkingDisabledOption" style="display: none;">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingDisabled" value="disabled" onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingDisabled">
                        <strong>Disabled</strong> - Turn off thinking completely
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="thinkingBudgetMode" id="thinkingCustom" value="custom" onchange="updateThinkingBudgetMode()">
                      <label class="form-check-label" for="thinkingCustom">
                        <strong>Custom</strong> - Set specific token budget
                      </label>
                    </div>
                  </div>

                  <!-- Custom slider (only shown when Custom is selected) -->
                  <div id="thinkingBudgetCustomContainer" style="display: none;">
                    <label for="thinkingBudgetSlider" class="form-label d-flex justify-content-between">
                      <span>Token Budget</span>
                      <span id="thinkingBudgetValue">1000</span>
                    </label>
                                         <input type="range" class="form-range" min="128" max="32768" step="128" id="thinkingBudgetSlider" value="1000" oninput="updateThinkingBudgetDisplay()">
                     <div class="d-flex justify-content-between">
                       <small class="text-muted" id="thinkingBudgetMin">128</small>
                       <small class="text-muted" id="thinkingBudgetMax">32768</small>
                     </div>
                  </div>

                  <small class="text-muted" id="thinkingBudgetHelp">Dynamic thinking: Model decides when and how much to think</small>
                </div>

                <h6 class="mb-3 mt-4">Tournament Controls</h6>

                <!-- Tournament Size -->
                <div class="mb-3">
                  <label for="tournamentSize" class="form-label d-flex justify-content-between">
                    <span>Tournament Size</span>
                    <span id="tournamentSizeValue">5</span>
                  </label>
                  <input type="range" class="form-range" min="2" max="10" step="1" id="tournamentSize" value="5" oninput="document.getElementById('tournamentSizeValue').textContent = this.value">
                  <small class="text-muted">Number of ideas in each tournament group</small>
                </div>

                <!-- Tournament Comparisons -->
                <div class="mb-3">
                  <label for="tournamentComparisons" class="form-label d-flex justify-content-between">
                    <span>Tournament Comparisons</span>
                    <span id="tournamentComparisonsValue">35</span>
                  </label>
                  <input type="range" class="form-range" min="5" max="100" step="5" id="tournamentComparisons" value="35" oninput="document.getElementById('tournamentComparisonsValue').textContent = this.value">
                  <small class="text-muted">Number of comparisons to run in each tournament</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="controls-section">
          <button class="btn btn-primary w-100 mb-2" id="startButton" {% if api_key_missing %}disabled{% endif %}>Start Evolution</button>
          <button class="btn btn-danger w-100 mb-2" id="stopButton" disabled style="display: none;">Stop Evolution</button>
          <button class="btn btn-secondary w-100" id="downloadButton" disabled>Save Results</button>
        </div>
      </div>

      <!-- Main content area -->
      <div class="main-content" id="mainContent">
        <div class="app-header main-header">
          <img src="/static/img/logo.png" alt="App Logo" class="app-logo">
          <h1>Open-Ended Idea Evolution</h1>
        </div>

        <!-- Template Generation Entry Point -->
        <div id="templateEntry" class="template-entry-section">
          <div class="entry-card">
            <h3>
              <i class="fas fa-magic me-2"></i>
              What kind of ideas do you want to generate?
            </h3>

            <div class="entry-form">
              <textarea
                class="form-control entry-input"
                id="ideaTypeInput"
                placeholder="Describe the ideas you want to generate and evolve, specifying any important constraints and/or evaluation criteria"
                rows="3"
              ></textarea>

              <div class="entry-actions mt-3">
                <button class="btn btn-primary" id="generateTemplateBtn">
                  <i class="fas fa-magic me-2"></i>Generate Evolution Template
                </button>
                <div class="entry-examples mt-2">
                  <small class="text-muted">
                    <strong>Try:</strong>
                    <span class="example-link" onclick="setEntryText('Arduino project ideas for beginners using only common components under $20 - outline only')">Arduino projects</span>
                    <span class="example-link" onclick="setEntryText('New and original concept for a superhero characters - short pitch')">Superhero character design</span>
                    <span class="example-link" onclick="setEntryText('Interesting Math problems solvable by high schoolers in under 5 minutes with elegant solutions')">Math problems</span>
                    <span class="example-link" onclick="setEntryText('Surprising Python code optimization tips demonstrable in under 10 lines of code')">Code optimizations</span>
                    <span class="example-link" onclick="setEntryText('Home science experiments using only kitchen materials and measurable results')">Kitchen science</span>

                  </small>
                </div>
              </div>

              <!-- Generation Status -->
              <div id="generationStatus" class="mt-3" style="display: none;">
                <div class="alert" id="statusAlert">
                  <span id="statusText"></span>
                </div>
              </div>

              <!-- Template Preview Section -->
              <div id="templatePreview" class="mt-4" style="display: none;">
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-check-circle me-2"></i>
                      Template Generated Successfully!
                    </h6>
                  </div>
                  <div class="card-body">
                    <!-- Warning about auto-generated templates -->
                    <div class="alert alert-warning mb-3">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Important:</strong> Templates have a large effect on evolution quality. This auto-generation is only meant to speed you up -
                      please review and edit the generated prompts for best results.
                    </div>

                    <div id="templatePreviewContent">
                      <!-- Template preview will be populated here -->
                    </div>
                    <div class="template-actions mt-3">
                      <button class="btn btn-primary me-2" id="saveTemplateBtn">
                        <i class="fas fa-save me-2"></i>Save & Use Template
                      </button>
                      <button class="btn btn-outline-secondary" id="reviewEditBtn">
                        <i class="fas fa-edit me-2"></i>Review & Edit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Existing Templates Section -->
          <div id="existingTemplates" class="mt-4" style="display: none;">
            <div class="entry-card">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                  <i class="fas fa-folder-open me-2"></i>
                  Or choose from existing templates:
                </h5>
                <button class="btn btn-outline-primary btn-sm" id="createTemplateBtn">
                  <i class="fas fa-plus me-1"></i>Create New
                </button>
              </div>

              <!-- Search and filter controls -->
              <div class="row mb-3">
                <div class="col-md-8">
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="templateSearchInput"
                           placeholder="Search templates by name, description, or author..."
                           onkeyup="searchTemplatesMainPage()">
                  </div>
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="templateFilterSelect" onchange="filterTemplatesMainPage()">
                    <option value="all">All Templates</option>
                    <option value="core">Core Templates</option>
                    <option value="custom">Custom Templates</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Template Name</th>
                      <th>Description</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="templatesTableBody">
                    <!-- Templates will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Evolution content container -->
        <div class="evolution-content">
          <!-- Hidden context container that will be used by JavaScript -->
          <div id="contextContainer" style="display: none; position: absolute; visibility: hidden;">
            <div id="contextDisplay" class="context-wrapper">
              <p class="text-muted">Context will appear here when evolution starts...</p>
            </div>
            <div class="context-navigation" style="display: none;">
              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="prevContext">&larr;</button>
                <small id="contextCounter" class="text-muted">Context 1 of 3</small>
                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="nextContext">&rarr;</button>
              </div>
            </div>
          </div>

          <!-- Generations will be rendered here -->
          <div id="generations-container" class="generations-container">
            <!-- Generation content will be dynamically added here -->
          </div>

          <!-- Diversity Plot Section -->
          <div id="diversity-plot-section" class="diversity-plot-section" style="display: none;">
            <div class="diversity-plot-header">
              <h3 class="diversity-plot-title">Population Diversity Evolution</h3>
              <div class="diversity-plot-controls">
                <button class="btn btn-sm btn-outline-primary" id="diversity-axis-toggle" title="Toggle between combined and split y-axes">
                  <i class="fas fa-arrows-alt-v"></i> Split Axes
                </button>
                <button class="diversity-plot-toggle btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#diversity-plot-content" aria-expanded="true" aria-controls="diversity-plot-content">
                  <i class="fas fa-chevron-up"></i>
                </button>
              </div>
            </div>
            <div class="collapse show" id="diversity-plot-content">
              <div class="diversity-plot-container">
                <canvas id="diversity-chart" width="800" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal fade" id="saveDataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save Evolution Results</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="saveFilename" class="form-label">Filename</label>
            <input type="text" class="form-control" id="saveFilename">
            <small class="text-muted">File will be saved in the data/ directory</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for idea details -->
  <div class="modal fade" id="ideaModal" tabindex="-1" aria-labelledby="ideaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ideaModalLabel">Idea Title</h5>
          <div class="d-flex align-items-start ms-auto">
            <button type="button" id="copyIdeaButton" class="btn btn-outline-secondary btn-sm me-2" title="Copy raw markdown">
              <i class="fa-regular fa-copy"></i>
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body">
          <div id="ideaModalContent" class="idea-content"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js library for cost visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sidebar Toggle Script -->
  <script>
    // Mobile "show" toggle + Desktop collapse with persistence
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const controlsPanel = document.getElementById('controlsPanel');
      const mainContent = document.getElementById('mainContent');

      function isMobile() {
        return window.innerWidth <= 576;
      }

      // Restore desktop collapse state
      const savedCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      if (!isMobile() && savedCollapsed) {
        controlsPanel.classList.add('collapsed');
        mainContent.classList.add('sidebar-collapsed');
      }

      function updateIcon() {
        const icon = sidebarToggle.querySelector('i');
        if (isMobile()) {
          icon.className = controlsPanel.classList.contains('show') ? 'fas fa-times' : 'fas fa-bars';
        } else {
          icon.className = controlsPanel.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
        }
      }

      sidebarToggle.addEventListener('click', function() {
        if (isMobile()) {
          controlsPanel.classList.toggle('show');
        } else {
          controlsPanel.classList.toggle('collapsed');
          mainContent.classList.toggle('sidebar-collapsed');
          localStorage.setItem('sidebarCollapsed', controlsPanel.classList.contains('collapsed'));
        }
        updateIcon();
      });

      // Initialize icon
      updateIcon();

      // Update icon on resize breakpoint changes
      window.addEventListener('resize', updateIcon);
    });
  </script>

  <!-- Template Generation JavaScript -->
  <script>
    // State management
    let currentGeneratedTemplate = null;
    let currentGeneratedTemplateId = null;  // Track if the generated template has been saved
    let currentMode = 'new'; // 'new' or 'evolution'

    document.addEventListener('DOMContentLoaded', function() {
      initializeInterface();

      // Template generation event listeners
      document.getElementById('generateTemplateBtn').addEventListener('click', handleTemplateGeneration);
      document.getElementById('saveTemplateBtn').addEventListener('click', saveAndUseTemplate);
      document.getElementById('reviewEditBtn').addEventListener('click', reviewAndEditTemplate);

      // State management event listeners
      document.getElementById('newEvolutionBtn').addEventListener('click', showNewEvolutionMode);
      document.getElementById('evolutionSelect').addEventListener('change', handleEvolutionSelection);

      // Enter key support
      document.getElementById('ideaTypeInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          handleTemplateGeneration();
        }
      });
    });

    async function initializeInterface() {
      // Start in new evolution mode
      await showNewEvolutionMode();
    }

    async function showNewEvolutionMode() {
      currentMode = 'new';

      // Show template entry section
      document.getElementById('templateEntry').style.display = 'block';

      // Hide new evolution button
      document.getElementById('newEvolutionBtn').style.display = 'none';

      // Clear evolution selector
      document.getElementById('evolutionSelect').value = '';

      // Clear evolution content
      document.getElementById('generations-container').innerHTML = '';
      document.getElementById('diversity-plot-section').style.display = 'none';

      // Load and show existing templates
      await loadExistingTemplates();

      // Clear any selected template in sidebar
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = 'No template selected';
      display.style.color = '#6c757d';
      display.style.fontStyle = 'italic';
      display.classList.remove('bg-success', 'text-white');
      display.classList.add('bg-light');
      document.getElementById('ideaType').value = '';
    }

    async function showEvolutionMode(evolutionId = null) {
      currentMode = 'evolution';

      // Hide template entry section
      document.getElementById('templateEntry').style.display = 'none';

      // Show new evolution button
      document.getElementById('newEvolutionBtn').style.display = 'inline-block';

      // If viewing a specific evolution, load it
      if (evolutionId) {
        // This would load the historical evolution data
        // For now, just show that we're in evolution mode
        document.getElementById('generations-container').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Loading evolution ${evolutionId}... (Historical evolution viewing to be implemented)
          </div>
        `;
      }
    }

    function handleEvolutionSelection() {
      const evolutionId = document.getElementById('evolutionSelect').value;

      if (evolutionId) {
        showEvolutionMode(evolutionId);
      } else {
        showNewEvolutionMode();
      }
    }

    // Hook for viewer.js to call when evolution starts
    window.onEvolutionStart = function() {
      if (currentMode === 'new') {
        showEvolutionMode();
      }
    };

    async function loadExistingTemplates() {
      try {
        const response = await fetch('/api/templates/');
        const data = await response.json();

        if (data.status === 'success') {
          displayExistingTemplates(data.templates);
          document.getElementById('existingTemplates').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    let allMainPageTemplates = {};
    let currentMainPageFilter = 'all';
    let currentMainPageSearch = '';

    function displayExistingTemplates(templates) {
      allMainPageTemplates = templates;
      renderFilteredTemplates();
    }

    function renderFilteredTemplates() {
      const tbody = document.getElementById('templatesTableBody');
      tbody.innerHTML = '';

      const filteredTemplates = filterAndSearchMainPageTemplates();

      Object.entries(filteredTemplates).forEach(([id, template]) => {
        if (!template.error) {
          const isCore = isCoreTemplate(id, template);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div class="d-flex align-items-center">
                <strong>${template.name || id}</strong>
                ${isCore ? '<span class="badge bg-success ms-2">Core</span>' : '<span class="badge bg-primary ms-2">Custom</span>'}
              </div>
            </td>
            <td>
              <span class="text-muted">${(template.description || '').substring(0, 100)}${(template.description || '').length > 100 ? '...' : ''}</span>
            </td>
            <td>
              <div class="btn-group" role="group" aria-label="Template actions">
                <button class="btn btn-sm btn-primary" onclick="selectExistingTemplate('${id}', '${template.name || id}')">
                  <i class="fas fa-arrow-right me-1"></i>Use
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="editTemplateMainPage('${id}')">
                  <i class="fas fa-edit me-1"></i>Edit
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        }
      });

      // Show empty state if no templates match filter
      if (Object.keys(filteredTemplates).length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="3" class="text-center text-muted py-4">
            <i class="fas fa-search fa-2x mb-2"></i><br>
            No templates found matching your search criteria.
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    function filterAndSearchMainPageTemplates() {
      let filtered = {};

      for (const [templateId, templateInfo] of Object.entries(allMainPageTemplates)) {
        if (templateInfo.error) continue;

        const isCore = isCoreTemplate(templateId, templateInfo);

        // Apply filter
        if (currentMainPageFilter === 'core' && !isCore) continue;
        if (currentMainPageFilter === 'custom' && isCore) continue;

        // Apply search
        if (currentMainPageSearch) {
          const searchTerm = currentMainPageSearch.toLowerCase();
          const name = (templateInfo.name || templateId).toLowerCase();
          const description = (templateInfo.description || '').toLowerCase();
          const author = (templateInfo.author || '').toLowerCase();

          if (!name.includes(searchTerm) &&
              !description.includes(searchTerm) &&
              !author.includes(searchTerm)) {
            continue;
          }
        }

        filtered[templateId] = templateInfo;
      }

      return filtered;
    }

    function isCoreTemplate(templateId, templateInfo) {
      // Core templates are the original ones: airesearch, drabble, game_design
      const coreTemplates = ['airesearch', 'drabble', 'game_design'];
      return coreTemplates.includes(templateId) || templateInfo.author === 'Original Idea App';
    }

    function searchTemplatesMainPage() {
      currentMainPageSearch = document.getElementById('templateSearchInput').value;
      renderFilteredTemplates();
    }

    function filterTemplatesMainPage() {
      currentMainPageFilter = document.getElementById('templateFilterSelect').value;
      renderFilteredTemplates();
    }

    function selectExistingTemplate(templateId, templateName) {
      // Set the hidden field value
      document.getElementById('ideaType').value = templateId;

      // Update the display
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = templateName;
      display.style.color = '#212529';
      display.style.fontStyle = 'normal';
      display.classList.remove('bg-light');
      display.classList.add('bg-success', 'text-white');

      // Scroll to configuration panel on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('controlsPanel').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function setEntryText(text) {
      document.getElementById('ideaTypeInput').value = text;
      document.getElementById('ideaTypeInput').focus();
    }

    async function handleTemplateGeneration() {
      const ideaType = document.getElementById('ideaTypeInput').value.trim();

      if (!ideaType) {
        showSimpleAlert('Please describe the type of ideas you want to generate.', 'warning');
        document.getElementById('ideaTypeInput').focus();
        return;
      }

      const btn = document.getElementById('generateTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        showStatus('Generating template with Gemini 2.5 Pro...', 'info');
        hideTemplatePreview();

        // Generate template
        const response = await fetch('/api/templates/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea_type_suggestion: ideaType })
        });

        const data = await response.json();

        if (data.status === 'success') {
          currentGeneratedTemplate = data.template;
          currentGeneratedTemplateId = null;  // Reset saved template tracking for new generation
          showTemplatePreview(data.template);
          hideStatus();
        } else {
          showStatus('Error: ' + (data.message || 'Failed to generate template'), 'danger');
        }
      } catch (error) {
        showStatus('Error: ' + error.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function showTemplatePreview(template) {
      const preview = document.getElementById('templatePreview');
      const content = document.getElementById('templatePreviewContent');

      // Show key details about the generated template
      content.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-8">
            <h5 class="text-success">${template.name}</h5>
            <p class="text-muted mb-2">${template.description}</p>
            <small class="text-muted">
              <strong>Item Type:</strong> ${template.metadata.item_type} |
              <strong>Criteria:</strong> ${template.comparison_criteria.slice(0, 2).join(', ')}${template.comparison_criteria.length > 2 ? '...' : ''}
            </small>
          </div>
          <div class="col-md-4">
            <div class="bg-light p-2 rounded">
              <small class="text-muted">
                <i class="fas fa-cog me-1"></i> Ready to save and use<br>
                <i class="fas fa-edit me-1"></i> Or review and customize
              </small>
            </div>
          </div>
        </div>
      `;

      preview.style.display = 'block';
    }

    function hideTemplatePreview() {
      document.getElementById('templatePreview').style.display = 'none';
    }

    async function saveAndUseTemplate() {
      if (!currentGeneratedTemplate) return;

      // If template was already saved, just select it
      if (currentGeneratedTemplateId) {
        selectNewTemplate(currentGeneratedTemplateId, currentGeneratedTemplate.name);
        return;
      }

      const btn = document.getElementById('saveTemplateBtn');
      const originalText = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

        const response = await fetch('/api/templates/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentGeneratedTemplate.name,
            description: currentGeneratedTemplate.description,
            author: currentGeneratedTemplate.author,
            item_type: currentGeneratedTemplate.metadata.item_type,
            special_requirements: currentGeneratedTemplate.special_requirements || '',
            context_prompt: currentGeneratedTemplate.prompts.context,
            specific_prompt: currentGeneratedTemplate.prompts.specific_prompt,
            idea_prompt: currentGeneratedTemplate.prompts.idea,
            format_prompt: currentGeneratedTemplate.prompts.format,
            critique_prompt: currentGeneratedTemplate.prompts.critique,
            refine_prompt: currentGeneratedTemplate.prompts.refine,
            breed_prompt: currentGeneratedTemplate.prompts.breed,
            genotype_encode_prompt: currentGeneratedTemplate.prompts.genotype_encode,
            comparison_criteria: currentGeneratedTemplate.comparison_criteria
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          // Track that this template has been saved
          currentGeneratedTemplateId = data.template_id;

          showSimpleAlert(`Template "${currentGeneratedTemplate.name}" saved successfully!`, 'success');

          // Auto-select the new template
          setTimeout(() => {
            selectNewTemplate(data.template_id, currentGeneratedTemplate.name);
          }, 500);
        } else {
          showSimpleAlert('Error saving: ' + data.message, 'error');
        }
      } catch (error) {
        showSimpleAlert('Error saving: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

        async function reviewAndEditTemplate() {
      if (!currentGeneratedTemplate) return;

      // If template was already saved, set up as editing existing template
      if (currentGeneratedTemplateId) {
        currentEditingTemplateId = currentGeneratedTemplateId;
        document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Template';
        document.getElementById('deleteTemplateMainPageBtn').style.display = 'inline-block';
      } else {
        // Set up as new template
        currentEditingTemplateId = null;
        document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-magic me-2"></i>Review Generated Template';
        document.getElementById('deleteTemplateMainPageBtn').style.display = 'none';
      }

      // Populate the form with the generated template data
      populateTemplateEditForm(currentGeneratedTemplate);

      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
      modal.show();
    }

    function selectNewTemplate(templateId, templateName) {
      // Set the hidden field value
      document.getElementById('ideaType').value = templateId;

      // Update the display
      const display = document.getElementById('ideaTypeDisplay');
      display.textContent = templateName;
      display.style.color = '#212529';
      display.style.fontStyle = 'normal';
      display.classList.remove('bg-light');
      display.classList.add('bg-success', 'text-white');

      // Clear the interface
      document.getElementById('ideaTypeInput').value = '';
      hideTemplatePreview();
      currentGeneratedTemplate = null;
      currentGeneratedTemplateId = null;

      // Reload the existing templates to include the new one
      loadExistingTemplates();
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('generationStatus');
      const alertDiv = document.getElementById('statusAlert');
      const textSpan = document.getElementById('statusText');

      alertDiv.className = `alert alert-${type}`;
      textSpan.innerHTML = message;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('generationStatus').style.display = 'none';
    }

    function showSimpleAlert(message, type) {
      const alertClass = type === 'error' ? 'danger' : type;
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';

      // Generate a unique ID for this alert
      const alertId = 'alert-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

      const alertHtml = `
        <div id="${alertId}" class="alert alert-${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
          <i class="fas fa-${icon} me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', alertHtml);

      // Auto-dismiss after 4 seconds
      const timeoutId = setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
          // Use Bootstrap's fade out animation
          alertElement.classList.remove('show');
          // Remove from DOM after animation completes
          setTimeout(() => {
            if (alertElement.parentNode) {
              alertElement.parentNode.removeChild(alertElement);
            }
          }, 150); // Bootstrap fade transition is 150ms
        }
      }, 4000);

      // Clear timeout if user manually closes the alert
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        alertElement.addEventListener('closed.bs.alert', () => {
          clearTimeout(timeoutId);
        });
      }
    }
    // Template editing functions for main page
    let currentEditingTemplateId = null;

    async function editTemplateMainPage(templateId) {
      currentEditingTemplateId = templateId;

      try {
        const response = await fetch(`/api/templates/${templateId}`);
        const data = await response.json();

        if (data.status === 'success') {
          populateTemplateEditForm(data.template);
          const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
          modal.show();
        } else {
          alert('Error loading template: ' + data.message);
        }
      } catch (error) {
        alert('Error loading template: ' + error.message);
      }
    }

    async function createTemplateMainPage() {
      currentEditingTemplateId = null;
      clearTemplateEditForm();
      document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Create New Template';
      const modal = new bootstrap.Modal(document.getElementById('templateEditModal'));
      modal.show();
    }

            function populateTemplateEditForm(template) {
      document.getElementById('templateEditModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Template';
      document.getElementById('editTemplateName').value = template.name || '';
      document.getElementById('editTemplateDescription').value = template.description || '';
      document.getElementById('editTemplateAuthor').value = template.author || 'User';
      document.getElementById('editTemplateItemType').value = template.metadata?.item_type || '';
      document.getElementById('editSpecialRequirements').value = template.special_requirements || '';

      // Populate all prompt fields
      document.getElementById('editContextPrompt').value = template.prompts?.context || '';
      document.getElementById('editSpecificPrompt').value = template.prompts?.specific_prompt || '';
      document.getElementById('editIdeaPrompt').value = template.prompts?.idea || '';
      document.getElementById('editFormatPrompt').value = template.prompts?.format || '';
      document.getElementById('editCritiquePrompt').value = template.prompts?.critique || '';
      document.getElementById('editRefinePrompt').value = template.prompts?.refine || '';
      document.getElementById('editBreedPrompt').value = template.prompts?.breed || '';
      document.getElementById('editGenotypePrompt').value = template.prompts?.genotype_encode || '';

      // Show delete button for existing templates
      document.getElementById('deleteTemplateMainPageBtn').style.display = 'inline-block';

      // Populate comparison criteria
      const criteriaContainer = document.getElementById('editCriteriaContainer');
      criteriaContainer.innerHTML = '';
      if (template.comparison_criteria && template.comparison_criteria.length > 0) {
        template.comparison_criteria.forEach(criterion => {
          addEditCriterion(criterion);
        });
      } else {
        addEditCriterion('');
      }
    }

            function clearTemplateEditForm() {
      document.getElementById('editTemplateName').value = '';
      document.getElementById('editTemplateDescription').value = '';
      document.getElementById('editTemplateAuthor').value = 'User';
      document.getElementById('editTemplateItemType').value = '';
      document.getElementById('editSpecialRequirements').value = '';

      // Clear all prompt fields
      document.getElementById('editContextPrompt').value = '';
      document.getElementById('editSpecificPrompt').value = '';
      document.getElementById('editIdeaPrompt').value = '';
      document.getElementById('editFormatPrompt').value = '';
      document.getElementById('editCritiquePrompt').value = '';
      document.getElementById('editRefinePrompt').value = '';
      document.getElementById('editBreedPrompt').value = '';
      document.getElementById('editGenotypePrompt').value = '';

      // Hide delete button for new templates
      document.getElementById('deleteTemplateMainPageBtn').style.display = 'none';

      const criteriaContainer = document.getElementById('editCriteriaContainer');
      criteriaContainer.innerHTML = '';
      addEditCriterion('');
    }

    function addEditCriterion(value = '') {
      const container = document.getElementById('editCriteriaContainer');
      const criterionDiv = document.createElement('div');
      criterionDiv.className = 'input-group mb-2';
      criterionDiv.innerHTML = `
        <input type="text" class="form-control criterion-input" placeholder="e.g., originality, feasibility, clarity" value="${value}">
        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(criterionDiv);
    }

        async function saveTemplateMainPage() {
      const name = document.getElementById('editTemplateName').value.trim();
      const description = document.getElementById('editTemplateDescription').value.trim();
      const author = document.getElementById('editTemplateAuthor').value.trim();
      const itemType = document.getElementById('editTemplateItemType').value.trim();
      const specialRequirements = document.getElementById('editSpecialRequirements').value.trim();

      // Get all prompt fields
      const contextPrompt = document.getElementById('editContextPrompt').value.trim();
      const specificPrompt = document.getElementById('editSpecificPrompt').value.trim();
      const ideaPrompt = document.getElementById('editIdeaPrompt').value.trim();
      const formatPrompt = document.getElementById('editFormatPrompt').value.trim();
      const critiquePrompt = document.getElementById('editCritiquePrompt').value.trim();
      const refinePrompt = document.getElementById('editRefinePrompt').value.trim();
      const breedPrompt = document.getElementById('editBreedPrompt').value.trim();
      const genotypePrompt = document.getElementById('editGenotypePrompt').value.trim();

      if (!name || !description || !itemType) {
        alert('Please fill in all required fields (Name, Description, Item Type).');
        return;
      }

      if (!contextPrompt || !specificPrompt || !ideaPrompt || !formatPrompt ||
          !critiquePrompt || !refinePrompt || !breedPrompt || !genotypePrompt) {
        alert('Please fill in all prompt fields. All prompts are required for a complete template.');
        return;
      }

      // Validate required placeholders
      const placeholderValidation = [
        { field: 'Specific Prompt', value: specificPrompt, required: ['{context_pool}'] },
        { field: 'Idea Prompt', value: ideaPrompt, required: ['{requirements}'] },
        { field: 'Format Prompt', value: formatPrompt, required: ['{input_text}'] },
        { field: 'Critique Prompt', value: critiquePrompt, required: ['{idea}'] },
        { field: 'Refine Prompt', value: refinePrompt, required: ['{idea}', '{critique}'] },
        { field: 'Breed Prompt', value: breedPrompt, required: ['{ideas}'] },
        { field: 'Genotype Encode Prompt', value: genotypePrompt, required: ['{idea_content}'] }
      ];

      for (const validation of placeholderValidation) {
        for (const placeholder of validation.required) {
          if (!validation.value.includes(placeholder)) {
            alert(`Error: ${validation.field} must include the placeholder ${placeholder}`);
            return;
          }
        }
      }

      // Get comparison criteria
      const criteriaInputs = document.querySelectorAll('.criterion-input');
      const criteria = Array.from(criteriaInputs)
        .map(input => input.value.trim())
        .filter(value => value.length > 0);

      if (criteria.length === 0) {
        alert('Please add at least one comparison criterion.');
        return;
      }

      const templateData = {
        name,
        description,
        author,
        item_type: itemType,
        special_requirements: specialRequirements || undefined,
        context_prompt: contextPrompt,
        specific_prompt: specificPrompt,
        idea_prompt: ideaPrompt,
        format_prompt: formatPrompt,
        critique_prompt: critiquePrompt,
        refine_prompt: refinePrompt,
        breed_prompt: breedPrompt,
        genotype_encode_prompt: genotypePrompt,
        comparison_criteria: criteria
      };

      try {
        const url = currentEditingTemplateId
          ? `/api/templates/${currentEditingTemplateId}`
          : '/api/templates/';
        const method = currentEditingTemplateId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(templateData)
        });

        const data = await response.json();

                if (data.status === 'success') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('templateEditModal'));
          modal.hide();

          // If this was a generated template being saved for the first time, track its ID
          if (!currentEditingTemplateId && currentGeneratedTemplate) {
            currentGeneratedTemplateId = data.template_id;
          }

          // Reload templates to show changes
          await loadExistingTemplates();

          const action = currentEditingTemplateId ? 'updated' : 'created';
          showSimpleAlert(`Template ${action} successfully!`, 'success');
        } else {
          alert('Error saving template: ' + data.message);
        }
      } catch (error) {
        alert('Error saving template: ' + error.message);
      }
    }

    async function deleteTemplateMainPage() {
      if (!currentEditingTemplateId) return;

      if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/templates/${currentEditingTemplateId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'success') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('templateEditModal'));
          modal.hide();

          // Reload templates to show changes
          await loadExistingTemplates();
          showSimpleAlert('Template deleted successfully!', 'success');
        } else {
          alert('Error deleting template: ' + data.message);
        }
      } catch (error) {
        alert('Error deleting template: ' + error.message);
      }
    }

    // Bind create template button
    document.addEventListener('DOMContentLoaded', function() {
      const createBtn = document.getElementById('createTemplateBtn');
      if (createBtn) {
        createBtn.addEventListener('click', createTemplateMainPage);
      }
    });

  </script>

  <!-- Template Edit Modal -->
  <div class="modal fade" id="templateEditModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="templateEditModalTitle">
            <i class="fas fa-edit me-2"></i>Edit Template
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
                 <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                      <form id="templateEditForm">
             <!-- Basic Information Section -->
             <div class="card mb-4">
               <div class="card-header">
                 <h6 class="mb-0">
                   <i class="fas fa-info-circle me-1"></i>Basic Information
                 </h6>
               </div>
               <div class="card-body">
                 <div class="row mb-3">
              <div class="col-md-6">
                <label for="editTemplateName" class="form-label">
                  <i class="fas fa-tag me-1"></i>Template Name *
                </label>
                <input type="text" class="form-control" id="editTemplateName" required
                       placeholder="Enter a descriptive name">
              </div>
              <div class="col-md-6">
                <label for="editTemplateAuthor" class="form-label">
                  <i class="fas fa-user me-1"></i>Author
                </label>
                <input type="text" class="form-control" id="editTemplateAuthor" value="User"
                       placeholder="Your name">
              </div>
            </div>

            <div class="mb-3">
              <label for="editTemplateDescription" class="form-label">
                <i class="fas fa-align-left me-1"></i>Description *
              </label>
              <textarea class="form-control" id="editTemplateDescription" rows="2" required
                        placeholder="Describe what this template is used for"></textarea>
            </div>

            <div class="mb-3">
              <label for="editTemplateItemType" class="form-label">
                <i class="fas fa-lightbulb me-1"></i>Item Type *
              </label>
              <input type="text" class="form-control" id="editTemplateItemType" required
                     placeholder="e.g., 'research ideas', 'business plans', 'stories'">
            </div>

                <!-- Special Requirements -->
                <div class="mb-3">
                  <label for="editSpecialRequirements" class="form-label">
                    <i class="fas fa-exclamation-circle me-1"></i>Special Requirements (Optional)
                  </label>
                  <textarea class="form-control" id="editSpecialRequirements" rows="3"
                            placeholder="Special constraints like word limits, formatting requirements, etc."></textarea>
                </div>

                <!-- Comparison Criteria -->
                <div class="mb-0">
                  <label class="form-label">
                    <i class="fas fa-balance-scale me-1"></i>Comparison Criteria *
                  </label>
                  <div id="editCriteriaContainer">
                    <!-- Criteria inputs will be added here -->
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditCriterion()">
                    <i class="fas fa-plus me-1"></i>Add Criterion
                  </button>
                  <div class="form-text">
                    These criteria will be used to evaluate and compare generated ideas.
                  </div>
                </div>
              </div>
            </div>

            <!-- Prompts Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-code me-1"></i>Template Prompts
                </h6>
              </div>
              <div class="card-body">

               <!-- Context Prompt -->
               <div class="mb-3">
                 <label for="editContextPrompt" class="form-label">
                   <strong>Context Prompt</strong> *
                   <small class="text-muted">(Generates diverse concepts for idea generation)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editContextPrompt" rows="6" required
                           placeholder="Generate a diverse list of 50 specific concepts for your domain..."></textarea>
               </div>

               <!-- Specific Prompt -->
               <div class="mb-3">
                 <label for="editSpecificPrompt" class="form-label">
                   <strong>Specific Prompt</strong> *
                   <small class="text-muted">(Creates focused prompts from context pool)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editSpecificPrompt" rows="4" required
                           placeholder="From the following concepts, select 2-3 that would create an interesting combination...
Must include: {context_pool}"></textarea>
                 <div class="form-text">
                   <strong>Required placeholder:</strong> <code>{context_pool}</code>
                 </div>
               </div>

               <!-- Idea Prompt -->
               <div class="mb-3">
                 <label for="editIdeaPrompt" class="form-label">
                   <strong>Idea Generation Prompt</strong> *
                   <small class="text-muted">(Main prompt for generating ideas)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editIdeaPrompt" rows="6" required
                           placeholder="Your idea must incorporate concepts from the context above...
Must include: {requirements}"></textarea>
                 <div class="form-text">
                   <strong>Required placeholder:</strong> <code>{requirements}</code>
                 </div>
               </div>

               <!-- Format Prompt -->
               <div class="mb-3">
                 <label for="editFormatPrompt" class="form-label">
                   <strong>Format Prompt</strong> *
                   <small class="text-muted">(Formats and structures the generated ideas)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editFormatPrompt" rows="4" required
                           placeholder="Take the following idea and rewrite it in a clear, structured format...
Must include: {input_text}"></textarea>
                 <div class="form-text">
                   <strong>Required placeholder:</strong> <code>{input_text}</code>
                 </div>
               </div>

               <!-- Critique Prompt -->
               <div class="mb-3">
                 <label for="editCritiquePrompt" class="form-label">
                   <strong>Critique Prompt</strong> *
                   <small class="text-muted">(Provides critical feedback on ideas)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editCritiquePrompt" rows="4" required
                           placeholder="You are a helpful AI that critiques ideas. Current Idea: {idea}
Please offer critical feedback..."></textarea>
                 <div class="form-text">
                   <strong>Required placeholder:</strong> <code>{idea}</code>
                 </div>
               </div>

               <!-- Refine Prompt -->
               <div class="mb-3">
                 <label for="editRefinePrompt" class="form-label">
                   <strong>Refine Prompt</strong> *
                   <small class="text-muted">(Improves ideas based on critique)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editRefinePrompt" rows="4" required
                           placeholder="Current Idea: {idea}
Critique: {critique}
Please review both and create a refined proposal..."></textarea>
                 <div class="form-text">
                   <strong>Required placeholders:</strong> <code>{idea}</code>, <code>{critique}</code>, <code>{requirements}</code>
                 </div>
               </div>

               <!-- Breed Prompt -->
               <div class="mb-3">
                 <label for="editBreedPrompt" class="form-label">
                   <strong>Breed Prompt</strong> *
                   <small class="text-muted">(Creates new ideas by combining existing ones)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editBreedPrompt" rows="4" required
                           placeholder="{ideas}
Analyze the above ideas to identify patterns and create a new idea that explores underrepresented approaches..."></textarea>
                 <div class="form-text">
                   <strong>Required placeholders:</strong> <code>{ideas}</code>, <code>{requirements}</code>
                 </div>
               </div>

               <!-- Genotype Encode Prompt -->
               <div class="mb-3">
                 <label for="editGenotypePrompt" class="form-label">
                   <strong>Genotype Encode Prompt</strong> *
                   <small class="text-muted">(Extracts fundamental elements from ideas)</small>
                 </label>
                 <textarea class="form-control font-monospace" id="editGenotypePrompt" rows="5" required
                           placeholder="You are an expert at analyzing ideas and extracting their fundamental building blocks...
Input: {idea_content}
Output: condensed list of basic elements, separated by semicolons"></textarea>
                 <div class="form-text">
                   <strong>Required placeholder:</strong> <code>{idea_content}</code>
                 </div>
               </div>
             </div>
           </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-danger me-auto" id="deleteTemplateMainPageBtn"
                  onclick="deleteTemplateMainPage()" style="display: none;">
            <i class="fas fa-trash me-1"></i>Delete
          </button>
          <button type="button" class="btn btn-primary" onclick="saveTemplateMainPage()">
            <i class="fas fa-save me-1"></i>Save Template
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include original viewer.js for evolution functionality -->
  <script src="/static/js/viewer.js"></script>
</body>
</html>
