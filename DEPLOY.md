# Cloud Deployment Guide

Deploy Idea Evolution to Google Cloud Run with one command.

## Prerequisites

1. **Google Cloud Project**: Create one at [console.cloud.google.com](https://console.cloud.google.com).
2. **Tools**: Ensure you have `gcloud` and `terraform` installed.
   - [Install gcloud CLI](https://cloud.google.com/sdk/docs/install)
3. **Firebase Setup** (One-time):
   - Go to [Firebase Console](https://console.firebase.google.com/).
   - Click **Add project** and select your Google Cloud Project.
   - Accept the Terms of Service and finish the setup.
### 4. Finalize Firebase Configuration
1.  **Enable Google Sign-In**:
    -   Go to [Firebase Console > Authentication > Sign-in method](https://console.firebase.google.com/).
    -   Enable **Google**.
2.  **Add Authorized Domain**:
    -   Get your Cloud Run Service URL from the deployment output (e.g., `https://idea-evolution-xyz-uc.a.run.app`).
    -   Go to **Authentication > Settings > Authorized domains**.
    -   Click **Add domain** and paste your Cloud Run domain (without `https://`).
    -   This is **required** for Google Sign-In to work on the deployed app.

## Quick Start

1. Login to Google Cloud:
   ```bash
   # Login for Terraform (infra)
   gcloud auth application-default login

   # Login for Deployment (image build)
   gcloud auth login
   ```

2. Run the deployment script:
   ```bash
   ./deploy.sh
   ```

   The script will:
   - Ask for your Project ID and Admin Emails (first run only).
   - Provision all infrastructure (Cloud Run, Firestore, Secrets, Firebase).
   - Configure the frontend (`idea/static/js/auth.js`) automatically.
   - Build and deploy the application.

3. **Important**: Enable Google Sign-in
   - The script will output a link to the Firebase Console at the end.
   - Go to that link (Authentication > Sign-in method).
   - Enable **Google** provider.
   - No other configuration is needed; the Authorized Domains are handled automatically.
   - **Manual Step**: If this is a fresh project, you must "Add Firebase" to your project in the Console first to accept the Terms of Service.

## Update Deployment

To deploy changes, simply run the script again:

```bash
./deploy.sh
```

## Security & Secrets

- **Authentication**: The app is secured with Google Sign-In. APIs that modify state (start/stop/resume evolution) require a valid login token.
- **Secrets**:
  - `terraform.tfvars` contains your Project ID and Admin Emails. This file is **gitignored** to prevent accidental leaks.
  - Encryption Keys are stored in **Google Secret Manager**, not in the code.
  - API Keys for Gemini are managed via the UI and stored securely in the user's session or `.env` (locally).
- **Generated Files** (gitignored, recreated on deploy):
  - `idea/static/js/auth.js` - Contains Firebase client config. Auto-generated by `deploy.sh`.

### Regenerating auth.js Manually

If you need to recreate `auth.js` without running a full deployment:

```bash
cd terraform
FIREBASE_CONFIG=$(terraform output -json firebase_config_json)
echo "const FIREBASE_CONFIG = $FIREBASE_CONFIG;" > ../idea/static/js/auth.js
```

## Local Development

To run locally using the cloud resources (Firestore, etc.):

1. Ensure you have the `terraform.tfvars` generated by the deploy script.
2. Set environment variables:
   ```bash
   export PROJECT_ID=$(grep project_id terraform/terraform.tfvars | cut -d'"' -f2 | tr -d ' ')
   export ADMIN_EMAILS="your-email@gmail.com"
   ```
3. Run the app:
   ```bash
   uvicorn idea.viewer:app --reload
   ```

## Troubleshooting

- **Permissions (403)**: Ensure you are an Owner or Editor of the project.
- **Project Mismatch**: Terraform uses `terraform.tfvars`. If you change projects, delete this file and run `./deploy.sh` again.
